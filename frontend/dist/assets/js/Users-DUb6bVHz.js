import{j as r,C as B,L as D,G as m,a as T,B as f,P as F,T as G,b as N,r as s,s as O,e as w,k as M,w as U,l as v,n as o}from"./mantine-vendor-D4AgWXPI.js";import{u as H,f as V}from"./index-cX4OG7Q0.js";import{r as l}from"./react-vendor-Q26-omST.js";import{u as h,p as $}from"./apiService-758Vinm-.js";import{S as J}from"./StableModal-C60p4KRL.js";import{I as K,a as Q}from"./IconPlus-BOpu3o19.js";import{I as W}from"./IconTrash-cT-LP-1K.js";import"./utils-vendor-CNi8B-Rx.js";function te(){const{user:p}=H(),c=(p==null?void 0:p.role)==="admin",[b,y]=l.useState([]),[j,C]=l.useState([]),[E,t]=l.useState(!0),[P,n]=l.useState(!1),[a,d]=l.useState(null),[i,x]=l.useState(""),g=async()=>{t(!0);try{const e=await h.getAll();y(e)}catch(e){console.error("Failed to fetch users:",e),o.show({title:"Error",message:"Error al cargar datos de usuarios",color:"red"})}finally{t(!1)}},I=async()=>{try{const e=await $.getAll();C(e)}catch(e){console.error("Failed to fetch persons:",e)}};l.useEffect(()=>{g(),I()},[]);const _=e=>{d({...e}),x(""),n(!0)},A=()=>{d({role:"user",email:"",person_id:""}),x(""),n(!0)},S=async e=>{if(confirm("¿Está seguro que desea eliminar este usuario?")){t(!0);try{await h.delete(e),o.show({title:"Éxito",message:"Usuario eliminado exitosamente",color:"green"}),g()}catch(u){console.error("Failed to delete user:",u),o.show({title:"Error",message:"Error al eliminar usuario",color:"red"})}finally{t(!1)}}},R=async()=>{if(!a||!a.email||!a.id&&!i){o.show({title:"Error",message:"Email y contraseña (para nuevos usuarios) son requeridos.",color:"red"});return}t(!0);try{if(a.id){const e={email:a.email,role:a.role};if(a.person_id&&(e.person_id=a.person_id),i){if(i.length<8){o.show({title:"Error",message:"La nueva contraseña debe tener al menos 8 caracteres.",color:"red"}),t(!1);return}e.password_base64=btoa(i)}await h.update(a.id,e),o.show({title:"Éxito",message:"Usuario actualizado exitosamente",color:"green"})}else{if(!i||i.length<8){o.show({title:"Error",message:"La contraseña es requerida y debe tener al menos 8 caracteres para nuevos usuarios.",color:"red"}),t(!1);return}const e={email:a.email,role:a.role,password_base64:btoa(i)};a.person_id&&(e.person_id=a.person_id),await h.create(e),o.show({title:"Éxito",message:"Usuario creado exitosamente",color:"green"})}n(!1),g()}catch(e){console.error("Failed to save user:",e),o.show({title:"Error",message:"Error al guardar usuario",color:"red"})}finally{t(!1)}},z=e=>{const u=j.find(q=>q.id===e);return u?u.full_name:"No asignado"},L=e=>{switch(e.toLowerCase()){case"admin":return"red";case"manager":return"blue";case"user":return"green";default:return"gray"}},k=e=>{switch(e.toLowerCase()){case"admin":return"Administrador";case"manager":return"Rentista";case"user":return"Usuario";default:return e}};return r.jsxs(B,{size:"xl",children:[r.jsx(D,{visible:E,overlayProps:{blur:2}}),r.jsxs(m,{justify:"space-between",mb:"xl",children:[r.jsx(T,{order:1,children:"Gestión de Usuarios"}),c&&r.jsx(f,{leftSection:r.jsx(K,{size:16}),onClick:A,"data-testid":"add-user-button",children:"Agregar Usuario"})]}),r.jsxs(F,{shadow:"sm",p:"lg",radius:"md",withBorder:!0,mb:"xl",children:[r.jsxs(m,{mb:"lg",children:[r.jsx(G,{size:"xl",color:"indigo",radius:"md",children:r.jsx(V,{size:24})}),r.jsx(T,{order:2,children:"Usuarios"})]}),b.length===0?r.jsxs(N,{c:"dimmed",ta:"center",py:"xl",children:["No se encontraron usuarios. ",c&&"Use el botón Agregar Usuario para crear uno."]}):r.jsxs(s,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[r.jsx(s.Thead,{children:r.jsxs(s.Tr,{children:[r.jsx(s.Th,{children:"ID"}),r.jsx(s.Th,{children:"Email"}),r.jsx(s.Th,{children:"Rol"}),r.jsx(s.Th,{children:"Persona"}),c&&r.jsx(s.Th,{children:"Acciones"})]})}),r.jsx(s.Tbody,{children:b.map(e=>r.jsxs(s.Tr,{children:[r.jsxs(s.Td,{children:[e.id.substring(0,8),"..."]}),r.jsx(s.Td,{children:e.email}),r.jsx(s.Td,{children:r.jsx(O,{color:L(e.role),children:k(e.role)})}),r.jsx(s.Td,{children:z(e.person_id||"")}),c&&r.jsx(s.Td,{children:r.jsxs(m,{gap:"xs",children:[r.jsx(w,{variant:"subtle",color:"blue",onClick:()=>_(e),children:r.jsx(Q,{size:16})}),r.jsx(w,{variant:"subtle",color:"red",onClick:()=>S(e.id),children:r.jsx(W,{size:16})})]})})]},e.id))})]})]}),r.jsxs(J,{opened:P,onClose:()=>n(!1),title:a!=null&&a.id?"Editar Usuario":"Agregar Usuario",centered:!0,size:"md",padding:"xl",radius:"md",transitionProps:{transition:"fade",duration:300},overlayProps:{blur:8},styles:{header:{backgroundColor:"#f8f9fa",borderBottom:"1px solid #e9ecef",padding:"16px",borderTopLeftRadius:"8px",borderTopRightRadius:"8px"},body:{padding:"20px"}},children:[r.jsx(M,{label:"Email",placeholder:"Ingrese email",required:!0,mb:"md",value:(a==null?void 0:a.email)||"",onChange:e=>{a&&d({...a,email:e.currentTarget.value})},error:a!=null&&a.email?null:"Email es requerido"}),r.jsx(U,{label:`${a!=null&&a.id?"Nueva ":""}Contraseña`,placeholder:a!=null&&a.id?"Dejar en blanco para mantener la contraseña actual":"Ingrese contraseña",required:!(a!=null&&a.id),mb:"md",value:i,onChange:e=>{x(e.currentTarget.value)}}),r.jsx(v,{label:"Rol",placeholder:"Seleccione rol",required:!0,mb:"md",data:[{value:"admin",label:"Administrador"},{value:"manager",label:"Rentista"},{value:"user",label:"Usuario"}],value:(a==null?void 0:a.role)||"",onChange:e=>{a&&d({...a,role:e||"user"})}}),r.jsx(v,{label:"Persona",placeholder:"Vincular a una persona (opcional)",mb:"xl",clearable:!0,data:j.map(e=>({value:e.id,label:e.full_name})),value:(a==null?void 0:a.person_id)||"",onChange:e=>{a&&d({...a,person_id:e||""})}}),r.jsxs(m,{justify:"flex-end",children:[r.jsx(f,{variant:"outline",onClick:()=>n(!1),children:"Cancelar"}),r.jsx(f,{onClick:e=>{e.preventDefault(),R()},"data-testid":"save-user-button",children:"Guardar"})]})]})]})}export{te as default};
