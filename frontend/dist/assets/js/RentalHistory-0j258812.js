import{f as L,j as a,C as de,G as p,T as ce,a as ue,B as f,P as he,L as pe,b as fe,r as l,s as ge,e as A,S as B,l as C,y,k as xe,n as h}from"./mantine-vendor-D4AgWXPI.js";import{c as me,u as je,I as be}from"./index-cX4OG7Q0.js";import{r as i}from"./react-vendor-Q26-omST.js";import{c as T,p as ve,r as Se,a as De}from"./apiService-758Vinm-.js";import{S as N}from"./StableModal-C60p4KRL.js";import{I as Ce}from"./IconFilter-CqFxLFPY.js";import{I as Te,a as we}from"./IconPlus-BOpu3o19.js";import{I as _e}from"./IconTrash-cT-LP-1K.js";import"./utils-vendor-CNi8B-Rx.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ee=me("outline","eye","IconEye",[["path",{d:"M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0",key:"svg-0"}],["path",{d:"M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6",key:"svg-1"}]]);function Re(){const{user:d}=je(),s=(d==null?void 0:d.role)==="admin",[w,_]=i.useState([]),[E,V]=i.useState([]),[P,H]=i.useState([]),[G,$]=i.useState([]),[q,c]=i.useState(!0),[U,{open:I,close:x}]=L(!1),[r,u]=i.useState(null),[o,F]=i.useState(!1),[Z,m]=L(!1),[j,z]=i.useState(null),[b,M]=i.useState(null),[v,k]=i.useState(""),S=async()=>{if(!d){_([]),c(!1);return}c(!0);try{let e,t;s&&(v?t={status:v}:j&&b&&(t={startDate:j.toISOString(),endDate:b.toISOString()})),e=await T.getForCurrentUser(d,t),_(e)}catch(e){console.error("Failed to fetch rental histories:",e),h.show({title:"Error",message:"Error al cargar datos de historial de alquileres",color:"red"}),_([])}finally{c(!1)}},J=async()=>{c(!0);try{const[e,t,n]=await Promise.all([ve.getAll(),Se.getAll(),De.getAll()]);V(e),H(t),$(n)}catch(e){console.error("Failed to fetch related data:",e)}finally{}};i.useEffect(()=>{d&&(S(),(s||d.role==="manager")&&J())},[d,v,j,b]);const K=e=>{u(e),F(!0),I()},Q=e=>{s&&(u(e),F(!1),I())},W=()=>{s&&(u({person_id:"",rental_id:"",status:"",end_reason:"",end_date:new Date().toISOString()}),F(!1),I())},X=async e=>{if(s&&confirm("¿Está seguro que desea eliminar este registro de historial?")){c(!0);try{await T.delete(e),h.show({title:"Éxito",message:"Registro de historial eliminado correctamente",color:"green"}),S()}catch(t){console.error("Failed to delete history record:",t),h.show({title:"Error",message:"Error al eliminar el registro de historial",color:"red"})}finally{c(!1)}}},ee=async()=>{var e,t;if(o){x();return}if(s){if(!r||!r.person_id||!r.rental_id||!r.status){h.show({title:"Error de Validación",message:"Por favor complete todos los campos requeridos (Persona, Alquiler, Estado).",color:"red"});return}c(!0);try{const n={...r,end_date:r.end_date?typeof r.end_date=="string"&&r.end_date.includes("T")?r.end_date:new Date(r.end_date).toISOString().split("T")[0]+"T00:00:00Z":new Date().toISOString()};n.id?(await T.update(n.id,n),h.show({title:"Éxito",message:"Registro de historial actualizado.",color:"green"})):(await T.create(n),h.show({title:"Éxito",message:"Registro de historial creado.",color:"green"})),x(),S()}catch(n){console.error("Failed to save history record:",n);const D=((t=(e=n.response)==null?void 0:e.data)==null?void 0:t.error)||"Error al guardar el registro.";h.show({title:"Error",message:D,color:"red"})}finally{c(!1)}}},ae=()=>{s&&(S(),m.close())},re=()=>{s&&(z(null),M(null),k(""),m.close())},te=e=>{if(!e)return"N/A";try{return new Date(e).toLocaleDateString()}catch{return"Fecha Inválida"}},se=e=>{const t=E.find(n=>n.id===e);return t?t.full_name:e?"ID: "+e.substring(0,8):"Desconocido"},R=e=>{const t=P.find(g=>g.id===e);if(!t)return e?"Alquiler ID: "+e.substring(0,8):"Desconocido";const n=G.find(g=>g.id===t.property_id),D=E.find(g=>g.id===t.renter_id);let Y=`Alquiler de ${D?D.full_name:"inquilino desconocido"}`;return n&&(Y+=` en ${n.address}`),Y},le=(e="")=>{switch(e==null?void 0:e.toLowerCase()){case"active":return"green";case"terminated":return"red";case"expired":return"orange";case"pending":return"blue";default:return"gray"}},ne=(e="")=>{switch(e==null?void 0:e.toLowerCase()){case"active":return"Activo";case"terminated":return"Terminado";case"expired":return"Expirado";case"pending":return"Pendiente";default:return e}},ie=s?E.map(e=>({value:e.id,label:e.full_name})):[],oe=s?P.map(e=>({value:e.id,label:R(e.id)})):[],O=[{value:"active",label:"Activo"},{value:"terminated",label:"Terminado"},{value:"expired",label:"Expirado"},{value:"pending",label:"Pendiente"}];return a.jsxs(de,{fluid:!0,children:[a.jsxs(p,{justify:"space-between",mb:"lg",children:[a.jsxs(p,{children:[a.jsx(ce,{size:"xl",radius:"md",variant:"gradient",gradient:{from:"cyan",to:"blue"},children:a.jsx(be,{size:28})}),a.jsx(ue,{order:2,children:"Historial de Alquileres"})]}),a.jsxs(p,{children:[s&&a.jsx(f,{leftSection:a.jsx(Ce,{size:14}),onClick:m.open,variant:"outline",children:"Filtrar"}),s&&a.jsx(f,{leftSection:a.jsx(Te,{size:14}),onClick:W,children:"Nuevo Historial"})]})]}),a.jsxs(he,{shadow:"sm",p:"md",withBorder:!0,children:[a.jsx(pe,{visible:q}),w.length===0&&!q&&a.jsx(fe,{ta:"center",p:"lg",children:"No hay registros de historial para mostrar."}),w.length>0&&a.jsxs(l,{striped:!0,highlightOnHover:!0,verticalSpacing:"sm",children:[a.jsx(l.Thead,{children:a.jsxs(l.Tr,{children:[a.jsx(l.Th,{children:"Persona"}),a.jsx(l.Th,{children:"Alquiler (Propiedad)"}),a.jsx(l.Th,{children:"Estado"}),a.jsx(l.Th,{children:"Fecha Fin"}),a.jsx(l.Th,{children:"Razón Fin"}),a.jsx(l.Th,{children:"Acciones"})]})}),a.jsx(l.Tbody,{children:w.map(e=>a.jsxs(l.Tr,{children:[a.jsx(l.Td,{children:se(e.person_id)}),a.jsx(l.Td,{children:R(e.rental_id)}),a.jsx(l.Td,{children:a.jsx(ge,{color:le(e.status),variant:"light",children:ne(e.status)})}),a.jsx(l.Td,{children:te(e.end_date)}),a.jsx(l.Td,{children:e.end_reason||"-"}),a.jsx(l.Td,{children:a.jsxs(p,{gap:"xs",wrap:"nowrap",children:[a.jsx(A,{variant:"subtle",color:"blue",onClick:()=>K(e),title:"Ver Detalles",children:a.jsx(Ee,{size:18})}),s&&a.jsx(A,{variant:"subtle",color:"yellow",onClick:()=>Q(e),title:"Editar",children:a.jsx(we,{size:18})}),s&&a.jsx(A,{variant:"subtle",color:"red",onClick:()=>X(e.id),title:"Eliminar",children:a.jsx(_e,{size:18})})]})})]},e.id))})]})]}),s&&a.jsx(N,{opened:Z,onClose:m.close,title:"Filtrar Historial",children:a.jsxs(B,{children:[a.jsx(C,{label:"Estado",placeholder:"Seleccione un estado",data:O,value:v,onChange:e=>k(e||""),clearable:!0}),a.jsx(y,{label:"Fecha de Inicio (Rango)",value:j,onChange:z,placeholder:"YYYY-MM-DD",clearable:!0}),a.jsx(y,{label:"Fecha de Fin (Rango)",value:b,onChange:M,placeholder:"YYYY-MM-DD",clearable:!0}),a.jsxs(p,{justify:"flex-end",mt:"md",children:[a.jsx(f,{variant:"default",onClick:re,children:"Limpiar"}),a.jsx(f,{onClick:ae,children:"Aplicar Filtros"})]})]})}),a.jsx(N,{opened:U,onClose:x,title:o?"Detalles del Historial":r!=null&&r.id?"Editar Historial":"Nuevo Historial",size:"lg",children:a.jsxs(B,{gap:"md",children:[a.jsx(C,{label:"Persona",placeholder:"Seleccione una persona",data:ie,value:(r==null?void 0:r.person_id)||"",onChange:e=>u(t=>({...t,person_id:e||""})),disabled:o||!s,required:!0,searchable:!0}),a.jsx(C,{label:"Alquiler (Inquilino en Propiedad)",placeholder:"Seleccione un alquiler",data:oe,value:(r==null?void 0:r.rental_id)||"",onChange:e=>u(t=>({...t,rental_id:e||""})),disabled:o||!s,required:!0,searchable:!0}),a.jsx(C,{label:"Estado",placeholder:"Seleccione un estado",data:O,value:(r==null?void 0:r.status)||"",onChange:e=>u(t=>({...t,status:e||""})),disabled:o||!s,required:!0}),a.jsx(y,{label:"Fecha de Fin",value:r!=null&&r.end_date?new Date(r.end_date):null,onChange:e=>u(t=>({...t,end_date:e?e.toISOString().split("T")[0]:""})),placeholder:"YYYY-MM-DD",disabled:o||!s,required:!0}),a.jsx(xe,{label:"Razón de Finalización",placeholder:"Ej: Contrato finalizado, Mudanza, etc.",value:(r==null?void 0:r.end_reason)||"",onChange:e=>u(t=>({...t,end_reason:e.currentTarget.value})),disabled:o||!s}),a.jsxs(p,{justify:"flex-end",mt:"md",children:[a.jsx(f,{variant:"default",onClick:x,children:o||!s?"Cerrar":"Cancelar"}),!o&&s&&a.jsx(f,{onClick:ee,children:"Guardar Historial"})]})]})})]})}export{Re as default};
