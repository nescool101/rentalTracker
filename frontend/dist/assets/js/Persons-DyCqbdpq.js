import{j as e,C as K,L as R,b as w,G as p,a as q,B as x,k as y,P as U,r as a,e as _,n as t}from"./mantine-vendor-D4AgWXPI.js";import{r as m}from"./react-vendor-Q26-omST.js";import{c as H,u as J}from"./utils-vendor-CNi8B-Rx.js";import{p as j}from"./apiService-758Vinm-.js";import{S as W}from"./StableModal-C60p4KRL.js";import{u as X}from"./index-cX4OG7Q0.js";import{I as Y,a as Z}from"./IconPlus-BOpu3o19.js";import{I as $}from"./IconSearch-D4DSsbHo.js";import{I as ee}from"./IconUserCircle-5qOnJh3A.js";import{I as re}from"./IconTrash-cT-LP-1K.js";function me(){const{user:s}=X(),n=(s==null?void 0:s.role)==="admin",l=(s==null?void 0:s.role)==="manager",A=!n&&!l,[g,L]=m.useState(""),[o,i]=m.useState(null),[C,d]=m.useState(!1),[u,T]=m.useState(!1),[I,h]=m.useState(!1),P=H();m.useEffect(()=>{C||(h(!1),i(null),T(!1))},[C]);const{data:O=[],isLoading:k,error:E}=J({queryKey:["persons",s==null?void 0:s.role,s==null?void 0:s.person_id],queryFn:async()=>{if(!s)return[];if(n||l)return j.getAll();if(s.person_id)try{const r=await j.getById(s.person_id);return r?[r]:[]}catch(r){return console.error("Failed to fetch user's own person data:",r),t.show({title:"Error",message:"No se pudo cargar su información personal.",color:"red"}),[]}return[]},enabled:!!s}),c=O.filter(r=>{var f,S,N;return r&&(((f=r.full_name)==null?void 0:f.toLowerCase().includes(g.toLowerCase()))||((S=r.phone)==null?void 0:S.toLowerCase().includes(g.toLowerCase()))||((N=r.nit)==null?void 0:N.toLowerCase().includes(g.toLowerCase())))}),z=r=>{i(r),T(!0),h(!1),d(!0)},B=r=>{i(r),T(!1),h(!1),d(!0)},M=()=>{i({id:"",full_name:"",phone:"",nit:""}),T(!1),h(!1),d(!0)},D=async r=>{if(!n){t.show({title:"Acceso Denegado",message:"No tiene permisos para eliminar personas.",color:"red"});return}if(window.confirm("¿Está seguro que desea eliminar esta persona? Esta acción es irreversible."))try{await j.delete(r),P.invalidateQueries({queryKey:["persons",s==null?void 0:s.role,s==null?void 0:s.person_id]}),t.show({title:"Éxito",message:"Persona eliminada correctamente",color:"green"})}catch{t.show({title:"Error",message:"Error al eliminar la persona",color:"red"})}},G=async()=>{if(h(!0),!o){t.show({title:"Error",message:"No hay datos de persona para guardar",color:"red"});return}if(!o.full_name||!o.phone||!o.nit){t.show({title:"Error de Validación",message:"Por favor complete todos los campos requeridos (Nombre, Teléfono, NIT).",color:"red"});return}if(!n&&!l){t.show({title:"Acceso Denegado",message:"No tiene permisos para guardar personas.",color:"red"});return}try{if(o.id)await j.update(o.id,o),t.show({title:"Éxito",message:"Persona actualizada correctamente",color:"green"});else{const{id:r,...f}=o;await j.create(f),t.show({title:"Éxito",message:"Persona creada correctamente",color:"green"})}P.invalidateQueries({queryKey:["persons",s==null?void 0:s.role,s==null?void 0:s.person_id]}),d(!1)}catch(r){console.error("Error saving person:",r),t.show({title:"Error",message:"Error al guardar la persona",color:"red"})}},b=n||l,Q=n,V=n||l,F=n||l;let v="Ver Persona";return V&&!(o!=null&&o.id)?v="Añadir Persona":b&&(o!=null&&o.id)&&!u&&(v="Editar Persona"),e.jsxs(K,{size:"xl",children:[e.jsx(R,{visible:k||!s}),E&&e.jsxs(w,{color:"red",children:["Error al cargar datos de personas: ",E instanceof Error?E.message:"Error desconocido"]}),e.jsxs(p,{justify:"space-between",mb:"md",children:[e.jsx(q,{order:1,children:"Gestión de Personas"}),n&&e.jsx(x,{leftSection:e.jsx(Y,{size:16}),onClick:M,"data-testid":"add-person-button",children:"Añadir Persona"})]}),F&&e.jsx(y,{placeholder:"Buscar personas por nombre, teléfono o NIT...",mb:"md",leftSection:e.jsx($,{size:16}),value:g,onChange:r=>L(r.currentTarget.value)}),A&&c.length===1&&e.jsxs(U,{shadow:"sm",p:"lg",radius:"md",withBorder:!0,mb:"xl",children:[e.jsxs(p,{mb:"sm",children:[e.jsx(ee,{size:24}),e.jsx(q,{order:3,children:"Mi Información Personal"})]}),e.jsxs(w,{children:[e.jsx("strong",{children:"Nombre:"})," ",c[0].full_name]}),e.jsxs(w,{children:[e.jsx("strong",{children:"Teléfono:"})," ",c[0].phone]}),e.jsxs(w,{children:[e.jsx("strong",{children:"NIT:"})," ",c[0].nit]}),e.jsx(x,{mt:"md",onClick:()=>z(c[0]),children:"Ver Detalles"})]}),(n||l)&&e.jsxs(a,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(a.Thead,{children:e.jsxs(a.Tr,{children:[e.jsx(a.Th,{children:"Nombre"}),e.jsx(a.Th,{children:"Teléfono"}),e.jsx(a.Th,{children:"NIT"}),b&&e.jsx(a.Th,{children:"Acciones"})]})}),e.jsx(a.Tbody,{children:c.length===0&&(n||l)?e.jsx(a.Tr,{children:e.jsx(a.Td,{colSpan:b?4:3,align:"center",children:"No se encontraron personas."})}):c.map(r=>e.jsxs(a.Tr,{children:[e.jsx(a.Td,{children:r.full_name}),e.jsx(a.Td,{children:r.phone}),e.jsx(a.Td,{children:r.nit}),b&&e.jsx(a.Td,{children:e.jsxs(p,{gap:"xs",children:[e.jsx(_,{variant:"subtle",color:"blue",onClick:()=>B(r),title:"Editar Persona",children:e.jsx(Z,{size:16})}),Q&&e.jsx(_,{variant:"subtle",color:"red",onClick:()=>D(r.id),title:"Eliminar Persona",children:e.jsx(re,{size:16})})]})})]},r.id))})]}),o&&e.jsxs(W,{opened:C,onClose:()=>d(!1),title:v,centered:!0,size:"md",padding:"xl",radius:"md",children:[e.jsx(y,{label:"Nombre Completo",placeholder:"Ingrese nombre completo",required:!0,readOnly:u,mb:"md",value:o.full_name||"",onChange:r=>i({...o,full_name:r.currentTarget.value}),error:I&&!o.full_name?"El nombre completo es requerido":null}),e.jsx(y,{label:"Teléfono",placeholder:"Ingrese número de teléfono",required:!0,readOnly:u,mb:"md",value:o.phone||"",onChange:r=>i({...o,phone:r.currentTarget.value}),error:I&&!o.phone?"El teléfono es requerido":null}),e.jsx(y,{label:"NIT",placeholder:"Ingrese NIT",required:!0,readOnly:u,mb:"lg",value:o.nit||"",onChange:r=>i({...o,nit:r.currentTarget.value}),error:I&&!o.nit?"El NIT es requerido":null}),!u&&(n||l)&&e.jsxs(p,{justify:"flex-end",children:[e.jsx(x,{variant:"default",onClick:()=>d(!1),children:"Cancelar"}),e.jsx(x,{onClick:G,"data-testid":"save-person-button",children:"Guardar"})]}),u&&e.jsx(p,{justify:"flex-end",children:e.jsx(x,{variant:"default",onClick:()=>d(!1),children:"Cerrar"})})]})]})}export{me as default};
