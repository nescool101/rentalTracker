import{j as e,C as $,a as d,b as S,m as z,P as E,L as I,S as _,k as u,G as D,B as N,t as m,D as F,n as A}from"./mantine-vendor-Bripv_3X.js";import{r as s}from"./react-vendor-Cmr1RT9l.js";import{u as J,I as T,g as k}from"./index-BGAR1JXy.js";import{p as B}from"./apiService-19GZqUtM.js";import"./utils-vendor-tZ1hTSV2.js";function V(){const{user:a,logout:L}=J(),[f,i]=s.useState(!1),[p,o]=s.useState(""),[h,x]=s.useState(""),[g,j]=s.useState(""),[b,v]=s.useState(""),[c,w]=s.useState(""),[l,y]=s.useState(""),[P,C]=s.useState(""),t=(a==null?void 0:a.role)==="admin"||(a==null?void 0:a.role)==="manager";s.useEffect(()=>{a!=null&&a.person_id&&O()},[a]);const O=async()=>{i(!0);try{if(!(a!=null&&a.person_id))return;const r=await B.getById(a.person_id);r&&(x(r.full_name||""),j(r.phone||""),v(r.address||""))}catch(r){console.error("Error fetching person data:",r),o("No se pudo cargar su información personal.")}finally{i(!1)}},q=async r=>{r.preventDefault(),i(!0),o("");try{if(!(a!=null&&a.person_id)){o("No se encontró información de perfil asociada a su cuenta.");return}await B.update(a.person_id,{id:a.person_id,full_name:h,phone:g,address:b}),A.show({title:"Perfil actualizado",message:"Su información personal ha sido actualizada exitosamente.",color:"green",icon:e.jsx(k,{size:16})})}catch(n){console.error("Error updating profile:",n),o("Error al actualizar su información personal.")}finally{i(!1)}},G=async r=>{if(r.preventDefault(),!c){o("Debe ingresar su contraseña actual");return}if(!l||l.length<8){o("La nueva contraseña debe tener al menos 8 caracteres");return}if(l!==P){o("Las contraseñas nuevas no coinciden");return}i(!0),o("");try{if(!(a!=null&&a.id)){o("Información de usuario incompleta");return}const n=await fetch(`/api/users/${a.id}/change-password`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.token||localStorage.getItem("auth_token")}`},body:JSON.stringify({current_password:c,new_password:l})});if(!n.ok){const U=await n.json();throw new Error(U.error||"Error al actualizar la contraseña")}A.show({title:"Contraseña actualizada",message:"Su contraseña ha sido actualizada exitosamente. Por favor, inicie sesión nuevamente.",color:"green",icon:e.jsx(k,{size:16})}),w(""),y(""),C(""),await L(),setTimeout(()=>{window.location.href="/login"},2e3)}catch(n){console.error("Error updating password:",n),o(n instanceof Error?n.message:"Error al actualizar su contraseña. Por favor, inténtelo de nuevo.")}finally{i(!1)}};return e.jsxs($,{size:"md",children:[e.jsx(d,{order:2,mb:"md",children:"Mi Perfil"}),e.jsx(S,{c:"dimmed",mb:"xl",children:"Actualice su información personal y contraseña"}),p&&e.jsx(z,{icon:e.jsx(T,{size:16}),title:"Error",color:"red",mb:"md",children:p}),e.jsxs(E,{withBorder:!0,p:"xl",radius:"md",mb:"xl",pos:"relative",children:[e.jsx(I,{visible:f}),e.jsx(d,{order:3,mb:"lg",children:"Información Personal"}),!t&&e.jsx(z,{icon:e.jsx(T,{size:16}),title:"Solo lectura",color:"blue",mb:"md",children:"Su información personal es de solo lectura. Solo los administradores pueden modificar estos datos."}),e.jsx("form",{onSubmit:q,children:e.jsxs(_,{children:[e.jsx(u,{label:"Nombre completo",placeholder:"Nombre completo",value:h,onChange:r=>x(r.target.value),required:!0,readOnly:!t,disabled:!t}),e.jsx(u,{label:"Teléfono",placeholder:"Teléfono de contacto",value:g,onChange:r=>j(r.target.value),readOnly:!t,disabled:!t}),e.jsx(u,{label:"Dirección",placeholder:"Dirección",value:b,onChange:r=>v(r.target.value),readOnly:!t,disabled:!t}),t&&e.jsx(D,{justify:"flex-end",mt:"md",children:e.jsx(N,{type:"submit",children:"Guardar cambios"})})]})})]}),e.jsxs(E,{withBorder:!0,p:"xl",radius:"md",pos:"relative",children:[e.jsx(I,{visible:f}),e.jsx(d,{order:3,mb:"lg",children:"Cambiar Contraseña"}),e.jsx("form",{onSubmit:G,children:e.jsxs(_,{children:[e.jsx(m,{label:"Contraseña actual",placeholder:"Ingrese su contraseña actual",value:c,onChange:r=>w(r.target.value),required:!0}),e.jsx(F,{my:"md"}),e.jsx(m,{label:"Nueva contraseña",placeholder:"Ingrese su nueva contraseña",value:l,onChange:r=>y(r.target.value),required:!0}),e.jsx(m,{label:"Confirmar nueva contraseña",placeholder:"Confirme su nueva contraseña",value:P,onChange:r=>C(r.target.value),required:!0}),e.jsx(S,{size:"xs",c:"dimmed",children:"La contraseña debe tener al menos 8 caracteres."}),e.jsx(D,{justify:"flex-end",mt:"md",children:e.jsx(N,{type:"submit",color:"blue",children:"Actualizar contraseña"})})]})})]})]})}export{V as default};
