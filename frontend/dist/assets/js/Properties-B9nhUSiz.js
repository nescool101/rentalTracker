import{j as e,C as W,L as X,b as c,G as p,a as N,B as z,P as F,T as I,k as h,r as d,s as Y,e as O,o as Z,l as A,t as ee,n as u}from"./mantine-vendor-D4AgWXPI.js";import{r as _}from"./react-vendor-Q26-omST.js";import{c as re,u as M}from"./utils-vendor-CNi8B-Rx.js";import{a as C,p as ae,u as se}from"./apiService-758Vinm-.js";import{c as ie,u as ne,b as R}from"./index-cX4OG7Q0.js";import{S as de}from"./StableModal-C60p4KRL.js";import{I as oe,a as te}from"./IconPlus-BOpu3o19.js";import{I as le}from"./IconSearch-D4DSsbHo.js";import{I as ce}from"./IconTrash-cT-LP-1K.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var me=ie("outline","home-check","IconHomeCheck",[["path",{d:"M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2",key:"svg-0"}],["path",{d:"M19 13.488v-1.488h2l-9 -9l-9 9h2v7a2 2 0 0 0 2 2h4.525",key:"svg-1"}],["path",{d:"M15 19l2 2l4 -4",key:"svg-2"}]]);function Ce(){const[v,K]=_.useState(""),[s,o]=_.useState(null),[y,x]=_.useState(!1),[m,w]=_.useState(!1),D=re(),{user:a}=ne(),n=(a==null?void 0:a.role)==="admin",t=(a==null?void 0:a.role)==="manager",Q=!n&&!t;_.useEffect(()=>{y||(w(!1),o(null))},[y]);const{data:T=[],isLoading:E,error:j}=M({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id],queryFn:async()=>{if(!a)return[];try{return n||t?await C.getAll():a.person_id?await C.getByResidentId(a.person_id)||[]:[]}catch(r){return console.error("Error fetching properties:",r),u.show({title:"Error de Carga",message:"No se pudieron cargar las propiedades.",color:"red"}),[]}},enabled:!!a}),{data:P=[]}=M({queryKey:["persons","all","forPropertiesPageDropdowns"],queryFn:ae.getAll,enabled:n||t}),{data:G=[]}=M({queryKey:["users","all","forPropertiesPageManagerDropdown"],queryFn:se.getAll,enabled:n}),k=P.filter(r=>G.some(i=>i.person_id===r.id&&(i.role==="manager"||i.role==="admin"))),l=T.filter(r=>{var i,g,b;return r&&(((i=r.address)==null?void 0:i.toLowerCase().includes(v.toLowerCase()))||((g=r.city)==null?void 0:g.toLowerCase().includes(v.toLowerCase()))||((b=r.state)==null?void 0:b.toLowerCase().includes(v.toLowerCase())))}),H=r=>{o({...r}),w(!1),x(!0)},U=()=>{o({id:"",address:"",apt_number:"",city:"",state:"",zip_code:"",type:"",resident_id:t&&!n&&(a!=null&&a.person_id)?a.person_id:"",manager_ids:t&&!n&&(a!=null&&a.person_id)?[a.person_id]:[]}),w(!1),x(!0)},$=async r=>{if(!n){u.show({title:"Acceso Denegado",message:"No tiene permisos para eliminar propiedades.",color:"red"});return}if(window.confirm("¿Está seguro que desea eliminar esta propiedad?"))try{await C.delete(r),D.invalidateQueries({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id]}),u.show({title:"Éxito",message:"Propiedad eliminada correctamente",color:"green"})}catch{u.show({title:"Error",message:"Error al eliminar la propiedad",color:"red"})}},B=r=>{var L;if(!r)return"No asignado";const i=P||[],g=k||[],b=i.find(q=>q.id===r);return b?b.full_name:((L=g.find(q=>q.id===r))==null?void 0:L.full_name)||"ID no encontrado"},S=r=>!r||r.length===0?"No asignado":r.map(i=>B(i)).join(", "),V=async()=>{if(w(!0),!s)return;if(!s.address||!s.city||!s.state||!s.zip_code||!s.type||n&&(!s.resident_id||!s.manager_ids||s.manager_ids.length===0)||t&&!n&&!s.resident_id){u.show({title:"Error de Validación",message:"Por favor complete todos los campos requeridos.",color:"red"});return}const r={...s};if(t&&!n&&(a!=null&&a.person_id)){const i=r.manager_ids?[...r.manager_ids]:[];i.includes(a.person_id)||i.push(a.person_id),r.manager_ids=i,(!r.resident_id||r.resident_id==="")&&(r.resident_id=a.person_id)}try{if(r.id)await C.update(r.id,r),u.show({title:"Éxito",message:"Propiedad actualizada correctamente",color:"green"});else{const{id:i,...g}=r;await C.create(g),u.show({title:"Éxito",message:"Propiedad creada correctamente",color:"green"})}D.invalidateQueries({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id]}),x(!1)}catch(i){console.error("Error saving property:",i),u.show({title:"Error",message:"Error al guardar la propiedad",color:"red"})}},f=n||t,J=s!=null&&s.id?f?"Editar Propiedad":"Detalles de la Propiedad":"Añadir Propiedad";return e.jsxs(W,{size:"xl",children:[e.jsx(X,{visible:E&&!j}),j&&e.jsxs(c,{color:"red",ta:"center",py:"xl",children:["Error al cargar propiedades: ",j.message]}),e.jsxs(p,{justify:"space-between",mb:"md",children:[e.jsx(N,{order:1,children:"Propiedades"}),n&&e.jsx(z,{leftSection:e.jsx(oe,{size:16}),onClick:U,"data-testid":"add-property-button",children:"Añadir Propiedad"})]}),t&&!n&&e.jsxs(F,{withBorder:!0,p:"md",mb:"lg",radius:"md",children:[e.jsxs(p,{align:"center",mb:"xs",children:[e.jsx(I,{color:"blue",size:"md",children:e.jsx(R,{size:16})}),e.jsx(c,{fw:500,children:"Información para Encargados"})]}),e.jsx(c,{size:"sm",mb:"md",children:"Como encargado, usted puede registrar una propiedad durante el proceso de registro. El administrador puede asignarle múltiples propiedades para gestionar o cambiar su estado de pago para activar su propiedad."}),T.filter(r=>{var i;return(i=r.manager_ids)==null?void 0:i.includes((a==null?void 0:a.person_id)||"")}).length===0&&e.jsx(c,{size:"sm",fs:"italic",c:"dimmed",children:"Para registrar su propiedad, complete el proceso de registro inicial del sistema. Si ya lo ha completado, contacte al administrador."})]}),(n||t)&&T.length>1&&e.jsx(h,{placeholder:"Buscar propiedades por dirección, ciudad o estado...",mb:"md",leftSection:e.jsx(le,{size:16}),value:v,onChange:r=>K(r.currentTarget.value)}),(n||t)&&!E&&!j&&e.jsxs(d,{striped:!0,highlightOnHover:!0,withTableBorder:!0,mt:"lg",children:[e.jsx(d.Thead,{children:e.jsxs(d.Tr,{children:[e.jsx(d.Th,{children:"Dirección"}),e.jsx(d.Th,{children:"Ciudad"}),e.jsx(d.Th,{children:"Tipo"}),e.jsx(d.Th,{children:"Residente"}),e.jsx(d.Th,{children:"Encargado (Manager)"}),f&&e.jsx(d.Th,{children:"Acciones"})]})}),e.jsx(d.Tbody,{children:l.length===0?e.jsx(d.Tr,{children:e.jsx(d.Td,{colSpan:f?6:5,ta:"center",children:"No se encontraron propiedades."})}):l.map(r=>e.jsxs(d.Tr,{children:[e.jsxs(d.Td,{children:[r.address,r.apt_number?`, ${r.apt_number}`:""]}),e.jsx(d.Td,{children:r.city}),e.jsx(d.Td,{children:e.jsx(Y,{children:r.type})}),e.jsx(d.Td,{children:B(r.resident_id)}),e.jsx(d.Td,{children:S(r.manager_ids)}),f&&e.jsx(d.Td,{children:e.jsxs(p,{gap:"xs",children:[e.jsx(O,{variant:"subtle",color:"blue",onClick:()=>H(r),title:"Editar",children:e.jsx(te,{size:16})}),n&&e.jsx(O,{variant:"subtle",color:"red",onClick:()=>$(r.id),title:"Eliminar",children:e.jsx(ce,{size:16})})]})})]},r.id))})]}),Q&&!E&&!j&&e.jsx(e.Fragment,{children:l.length===1?e.jsxs(Z,{withBorder:!0,radius:"md",p:"xl",shadow:"sm",mt:"lg",children:[e.jsxs(p,{mb:"xs",children:[e.jsx(I,{variant:"light",size:36,radius:"md",children:e.jsx(me,{size:20})}),e.jsx(N,{order:3,children:"Mi Propiedad"})]}),e.jsxs(c,{children:[e.jsx("strong",{children:"Dirección:"})," ",l[0].address,l[0].apt_number?`, ${l[0].apt_number}`:""]}),e.jsxs(c,{children:[e.jsx("strong",{children:"Ciudad:"})," ",l[0].city,", ",l[0].state," ",l[0].zip_code]}),e.jsxs(c,{children:[e.jsx("strong",{children:"Tipo:"})," ",l[0].type]}),e.jsxs(c,{children:[e.jsx("strong",{children:"Encargado:"})," ",S(l[0].manager_ids)]})]}):e.jsxs(F,{withBorder:!0,p:"xl",radius:"md",shadow:"sm",mt:"lg",children:[e.jsx(p,{justify:"center",mb:"sm",children:e.jsx(I,{variant:"light",color:"gray",size:48,radius:"xl",children:e.jsx(R,{size:28})})}),e.jsx(c,{ta:"center",c:"dimmed",children:"No tiene una propiedad asignada actualmente o no se pudo cargar la información."}),e.jsx(c,{ta:"center",c:"dimmed",fz:"xs",children:"Si cree que esto es un error, por favor contacte con la administración."})]})}),s&&y&&f&&e.jsxs(de,{opened:y,onClose:()=>x(!1),title:J,centered:!0,size:"lg",children:[e.jsx(h,{label:"Dirección",placeholder:"Ingrese dirección",required:!0,mb:"sm",value:s.address,onChange:r=>o({...s,address:r.target.value}),error:m&&!s.address?"Campo requerido":null}),e.jsx(h,{label:"Nº Apartamento (Opcional)",placeholder:"Ej: Apto 101",mb:"sm",value:s.apt_number||"",onChange:r=>o({...s,apt_number:r.target.value})}),e.jsxs(p,{grow:!0,mb:"sm",children:[e.jsx(h,{label:"Ciudad",placeholder:"Ingrese ciudad",required:!0,value:s.city,onChange:r=>o({...s,city:r.target.value}),error:m&&!s.city?"Campo requerido":null}),e.jsx(h,{label:"Estado/Provincia",placeholder:"Ingrese estado",required:!0,value:s.state,onChange:r=>o({...s,state:r.target.value}),error:m&&!s.state?"Campo requerido":null})]}),e.jsxs(p,{grow:!0,mb:"sm",children:[e.jsx(h,{label:"Código Postal",placeholder:"Ingrese código postal",required:!0,value:s.zip_code,onChange:r=>o({...s,zip_code:r.target.value}),error:m&&!s.zip_code?"Campo requerido":null}),e.jsx(A,{label:"Tipo de Propiedad",placeholder:"Seleccione tipo",required:!0,data:["Apartamento","Casa","Condominio","Comercial","Otro"],value:s.type,onChange:r=>o({...s,type:r||""}),error:m&&!s.type?"Campo requerido":null})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx(A,{label:"Residente Asignado",placeholder:"Seleccione residente",clearable:!0,mb:"sm",searchable:!0,data:P.map(r=>({value:r.id,label:r.full_name})),value:s.resident_id||"",onChange:r=>o({...s,resident_id:r||""}),error:m&&!s.resident_id?"Debe asignar un residente":null}),e.jsx(ee,{label:"Encargado(s) (Manager)",placeholder:"Seleccione encargado(s)",clearable:!0,searchable:!0,mb:"lg",data:k.map(r=>({value:r.id,label:r.full_name})),value:s.manager_ids||[],onChange:r=>o({...s,manager_ids:r||[]}),error:m&&n&&(!s.manager_ids||s.manager_ids.length===0)?"Debe asignar al menos un encargado":null})]}),t&&!n&&e.jsxs(e.Fragment,{children:[e.jsx(A,{label:"Residente Asignado",placeholder:"Seleccione residente",clearable:!0,mb:"sm",searchable:!0,data:P.map(r=>({value:r.id,label:r.full_name})),value:s.resident_id||"",onChange:r=>o({...s,resident_id:r||""}),error:m&&!s.resident_id?"Debe asignar un residente":null,description:"De forma temporal, usted puede ser asignado como residente hasta que se cree el inquilino. Si no selecciona a nadie, se usará su información automáticamente."}),e.jsx(h,{label:"Encargado(s) (Manager)",disabled:!0,value:S(s.manager_ids),mb:"lg",description:s.id?"Para cambiar encargados, contacte a un administrador.":"Usted será asignado como encargado."})]}),e.jsxs(p,{justify:"flex-end",children:[e.jsx(z,{variant:"default",onClick:()=>x(!1),children:"Cancelar"}),e.jsx(z,{onClick:V,children:"Guardar Propiedad"})]})]})]})}export{Ce as default};
