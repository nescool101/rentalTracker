import{j as t,C as re,L as te,b as ne,G as T,a as ie,B as C,k as ae,r as o,s as oe,e as O,l as P,x as se,y as de,n as d}from"./mantine-vendor-D4AgWXPI.js";import{r as x}from"./react-vendor-Q26-omST.js";import{u as D}from"./utils-vendor-CNi8B-Rx.js";import{a as q,r as le,m as I,p as ce}from"./apiService-758Vinm-.js";import{c as pe,u as ue}from"./index-cX4OG7Q0.js";import{S as he}from"./StableModal-C60p4KRL.js";import{I as fe,a as me}from"./IconPlus-BOpu3o19.js";import{I as ge}from"./IconSearch-D4DSsbHo.js";import{I as xe}from"./IconTrash-cT-LP-1K.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var _e=pe("outline","refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]]);function Ie(){const{user:r}=ue(),s=(r==null?void 0:r.role)==="admin",l=(r==null?void 0:r.role)==="manager",h=(r==null?void 0:r.role)==="resident"||(r==null?void 0:r.role)==="user",[A,F]=x.useState(""),[i,f]=x.useState(null),[S,j]=x.useState(!1),[w,y]=x.useState([]),[G,b]=x.useState([]);x.useEffect(()=>{S||f(null)},[S]);const{data:v=[],isLoading:K,error:M,refetch:E}=D({queryKey:["maintenance-requests",r==null?void 0:r.id,r==null?void 0:r.role,r==null?void 0:r.person_id],queryFn:()=>I.getForCurrentUser(r),enabled:!!r}),{data:g=[]}=D({queryKey:["allPropertiesGlobal"],queryFn:q.getAll,enabled:s||l}),{data:p=[]}=D({queryKey:["allPersonsGlobal"],queryFn:ce.getAll,enabled:s||l});x.useEffect(()=>{r&&s&&(y(g),b(p))},[r,s,g,p]);const L=(v==null?void 0:v.filter(e=>e&&e.description&&e.description.toLowerCase().includes(A.toLowerCase())))||[],H=e=>r?s?!0:l?w.some(n=>n.id===e.property_id):h?e.renter_id===r.person_id:!1:!1,Q=e=>r?s||l&&w.some(n=>n.id===e.property_id):!1,z=e=>r?s?!0:l?w.some(n=>n.id===e.property_id):h?e.renter_id===r.person_id:!1:!1,U=async e=>{if(r){if(f({...e}),s)y(g),b(p);else if(l&&r.person_id){const n=await q.getByManagerId(r.person_id);y(n),b(p)}else if(h&&r.person_id){const n=g.find(c=>c.id===e.property_id);y(n?[n]:[]);const a=p.find(c=>c.id===r.person_id);b(a?[a]:[])}j(!0)}},J=async()=>{var k;if(!r||!r.person_id){d.show({title:"Información Requerida",message:"Su ID de persona no está configurado. No puede crear solicitudes.",color:"orange"});return}let e="",n=r.person_id,a=[],c=[];if(s)a=g,c=p;else if(l&&r.person_id){const u=await q.getByManagerId(r.person_id);a=u,u.length>0&&(e=u[0].id),c=p}else if(h&&r.person_id)try{const u=await le.getByRenterId(r.person_id)||[];let _;if(u.length>0){const m=u.find(R=>new Date(R.end_date)>new Date),N=m?m.property_id:(k=u[0])==null?void 0:k.property_id;N&&(_=g.find(R=>R.id===N))}if(!_){const m=await q.getByResidentId(r.person_id);m&&m.length>0&&(_=m[0])}_?(a=[_],e=_.id):d.show({title:"Propiedad no encontrada",message:"No se encontró una propiedad asociada para crear la solicitud.",color:"orange"});const B=p.find(m=>m.id===r.person_id);c=B?[B]:[]}catch(u){console.error("Error fetching resident data for add request:",u),d.show({title:"Error de Datos",message:"No se pudo cargar su información de propiedad/inquilino.",color:"red"})}y(a),b(c),f({id:"",property_id:e,renter_id:n,description:"",request_date:new Date().toISOString(),status:"pending"}),j(!0)},V=async e=>{const n=v.find(a=>a.id===e);if(!n||!z(n)){d.show({title:"Error",message:"No autorizado para eliminar.",color:"red"});return}try{await I.delete(e),E(),d.show({title:"Éxito",message:"Solicitud eliminada.",color:"green"})}catch{d.show({title:"Error",message:"Error al eliminar.",color:"red"})}},W=e=>{const n=g.find(a=>a.id===e);return n?n.address:"Desconocido"},X=e=>{const n=p.find(a=>a.id===e);return n?n.full_name:"Desconocido"},Y=e=>{switch(e==null?void 0:e.toLowerCase()){case"pending":return"yellow";case"in progress":case"in_progress":return"blue";case"completed":return"green";case"cancelled":return"red";default:return"gray"}},Z=e=>{switch(e==null?void 0:e.toLowerCase()){case"pending":return"Pendiente";case"in progress":case"in_progress":return"En Progreso";case"completed":return"Completado";case"cancelled":return"Cancelado";default:return e||"Desconocido"}},$=async()=>{if(!i||!i.description){d.show({title:"Error",message:"La descripción es requerida.",color:"red"});return}if(!i.property_id&&(s||l)){d.show({title:"Error",message:"La propiedad es requerida para administradores/encargados.",color:"red"});return}if(h&&(r!=null&&r.person_id))if(!i.id||i.renter_id===r.person_id)i.renter_id=r.person_id;else{d.show({title:"Error",message:"No puede cambiar el solicitante de esta petición.",color:"red"});return}const e={...i,request_date:i.request_date?new Date(i.request_date).toISOString():new Date().toISOString()};try{if(e.id)await I.update(e.id,e),d.show({title:"Éxito",message:"Solicitud actualizada.",color:"green"});else{const{id:n,...a}=e;await I.create(a),d.show({title:"Éxito",message:"Solicitud creada.",color:"green"})}E(),j(!1)}catch(n){console.error("Error saving maintenance request:",n),d.show({title:"Error",message:"Error al guardar.",color:"red"})}},ee=s||l||h;return t.jsxs(re,{size:"xl",children:[t.jsx(te,{visible:K||!r}),M&&t.jsxs(ne,{color:"red",children:["Error al cargar solicitudes: ",M.message]}),t.jsxs(T,{justify:"space-between",mb:"md",children:[t.jsx(ie,{order:1,children:"Solicitudes de Mantenimiento"}),t.jsxs(T,{children:[t.jsx(C,{leftSection:t.jsx(_e,{size:16}),variant:"outline",onClick:()=>E(),children:"Actualizar"}),ee&&t.jsx(C,{leftSection:t.jsx(fe,{size:16}),onClick:J,"data-testid":"add-maintenance-request-button",children:"Nueva Solicitud"})]})]}),t.jsx(ae,{placeholder:"Buscar por descripción...",mb:"md",leftSection:t.jsx(ge,{size:16}),value:A,onChange:e=>F(e.currentTarget.value)}),t.jsxs(o,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[t.jsx(o.Thead,{children:t.jsxs(o.Tr,{children:[t.jsx(o.Th,{children:"Propiedad"}),t.jsx(o.Th,{children:"Solicitante"}),t.jsx(o.Th,{children:"Descripción"}),t.jsx(o.Th,{children:"Fecha"}),t.jsx(o.Th,{children:"Estado"}),t.jsx(o.Th,{children:"Acciones"})]})}),t.jsx(o.Tbody,{children:L.length===0?t.jsx(o.Tr,{children:t.jsx(o.Td,{colSpan:6,align:"center",children:"No se encontraron solicitudes"})}):L.map(e=>t.jsxs(o.Tr,{children:[t.jsx(o.Td,{children:W(e.property_id)}),t.jsx(o.Td,{children:X(e.renter_id)}),t.jsx(o.Td,{children:e.description}),t.jsx(o.Td,{children:new Date(e.request_date).toLocaleDateString()}),t.jsx(o.Td,{children:t.jsx(oe,{color:Y(e.status),children:Z(e.status)})}),t.jsx(o.Td,{children:t.jsxs(T,{gap:"xs",children:[H(e)&&t.jsx(O,{variant:"subtle",color:"blue",onClick:()=>U(e),children:t.jsx(me,{size:16})}),z(e)&&t.jsx(O,{variant:"subtle",color:"red",onClick:()=>V(e.id),children:t.jsx(xe,{size:16})})]})})]},e.id))})]}),S&&i&&t.jsxs(he,{opened:S,onClose:()=>j(!1),title:i.id?"Editar Solicitud":"Nueva Solicitud",centered:!0,size:"lg",children:[t.jsx(P,{label:"Propiedad",placeholder:"Seleccione una propiedad",data:w.map(e=>({value:e.id,label:e.address})),value:i.property_id,onChange:e=>f(n=>({...n,property_id:e||""})),required:!0,disabled:h&&!!i.id,mb:"md"}),t.jsx(P,{label:"Solicitante (Inquilino)",placeholder:"Seleccione un inquilino",data:G.map(e=>({value:e.id,label:e.full_name})),value:i.renter_id,onChange:e=>f(n=>({...n,renter_id:e||""})),required:!0,disabled:h,mb:"md"}),t.jsx(se,{label:"Descripción",placeholder:"Describa el problema",required:!0,value:i.description,onChange:e=>{var a;const n=(a=e.currentTarget)==null?void 0:a.value;n!==void 0&&f(c=>({...c,description:n}))},disabled:l&&!!i.id&&i.renter_id!==(r==null?void 0:r.person_id),mb:"md",minRows:3}),t.jsx(de,{label:"Fecha de Solicitud",value:i.request_date?new Date(i.request_date):new Date,onChange:e=>f(n=>({...n,request_date:(e==null?void 0:e.toISOString())||new Date().toISOString()})),required:!0,disabled:!s&&!!i.id,mb:"md"}),t.jsx(P,{label:"Estado",placeholder:"Seleccione un estado",data:[{value:"pending",label:"Pendiente"},{value:"in_progress",label:"En Progreso"},{value:"completed",label:"Completado"},{value:"cancelled",label:"Cancelado"}],value:i.status,onChange:e=>f(n=>({...n,status:e||"pending"})),required:!0,disabled:!Q(i),mb:"xl"}),t.jsxs(T,{justify:"flex-end",children:[t.jsx(C,{variant:"outline",onClick:()=>j(!1),children:"Cancelar"}),t.jsx(C,{onClick:$,children:"Guardar"})]})]})]})}export{Ie as default};
