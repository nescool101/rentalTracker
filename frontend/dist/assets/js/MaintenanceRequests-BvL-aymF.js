import{j as t,C as re,L as te,b as ne,G as v,a as ie,B as q,k as ae,q as o,r as oe,e as F,l as D,v as se,w as de,n as d}from"./mantine-vendor-Bripv_3X.js";import{r as x}from"./react-vendor-Cmr1RT9l.js";import{u as R}from"./utils-vendor-tZ1hTSV2.js";import{a as C,r as le,m as I,p as ce}from"./apiService-19GZqUtM.js";import{u as pe}from"./index-BGAR1JXy.js";import{S as ue}from"./StableModal-BsXR2I9w.js";import{I as he}from"./IconRefresh-c4GWuNKm.js";import{I as fe,a as me}from"./IconPlus-dymNjJLj.js";import{I as ge}from"./IconSearch-f2W8sUQc.js";import{I as xe}from"./IconTrash-C4TwLzKL.js";function Ie(){const{user:r}=pe(),s=(r==null?void 0:r.role)==="admin",l=(r==null?void 0:r.role)==="manager",h=(r==null?void 0:r.role)==="resident"||(r==null?void 0:r.role)==="user",[A,k]=x.useState(""),[i,f]=x.useState(null),[y,j]=x.useState(!1),[w,b]=x.useState([]),[G,S]=x.useState([]);x.useEffect(()=>{y||f(null)},[y]);const{data:T=[],isLoading:K,error:M,refetch:E}=R({queryKey:["maintenance-requests",r==null?void 0:r.id,r==null?void 0:r.role,r==null?void 0:r.person_id],queryFn:()=>I.getForCurrentUser(r),enabled:!!r}),{data:g=[]}=R({queryKey:["allPropertiesGlobal"],queryFn:C.getAll,enabled:s||l}),{data:p=[]}=R({queryKey:["allPersonsGlobal"],queryFn:ce.getAll,enabled:s||l});x.useEffect(()=>{r&&s&&(b(g),S(p))},[r,s,g,p]);const L=(T==null?void 0:T.filter(e=>e&&e.description&&e.description.toLowerCase().includes(A.toLowerCase())))||[],H=e=>r?s?!0:l?w.some(n=>n.id===e.property_id):h?e.renter_id===r.person_id:!1:!1,Q=e=>r?s||l&&w.some(n=>n.id===e.property_id):!1,z=e=>r?s?!0:l?w.some(n=>n.id===e.property_id):h?e.renter_id===r.person_id:!1:!1,U=async e=>{if(r){if(f({...e}),s)b(g),S(p);else if(l&&r.person_id){const n=await C.getByManagerId(r.person_id);b(n),S(p)}else if(h&&r.person_id){const n=g.find(c=>c.id===e.property_id);b(n?[n]:[]);const a=p.find(c=>c.id===r.person_id);S(a?[a]:[])}j(!0)}},J=async()=>{var B;if(!r||!r.person_id){d.show({title:"Información Requerida",message:"Su ID de persona no está configurado. No puede crear solicitudes.",color:"orange"});return}let e="",n=r.person_id,a=[],c=[];if(s)a=g,c=p;else if(l&&r.person_id){const u=await C.getByManagerId(r.person_id);a=u,u.length>0&&(e=u[0].id),c=p}else if(h&&r.person_id)try{const u=await le.getByRenterId(r.person_id)||[];let _;if(u.length>0){const m=u.find(P=>new Date(P.end_date)>new Date),O=m?m.property_id:(B=u[0])==null?void 0:B.property_id;O&&(_=g.find(P=>P.id===O))}if(!_){const m=await C.getByResidentId(r.person_id);m&&m.length>0&&(_=m[0])}_?(a=[_],e=_.id):d.show({title:"Propiedad no encontrada",message:"No se encontró una propiedad asociada para crear la solicitud.",color:"orange"});const N=p.find(m=>m.id===r.person_id);c=N?[N]:[]}catch(u){console.error("Error fetching resident data for add request:",u),d.show({title:"Error de Datos",message:"No se pudo cargar su información de propiedad/inquilino.",color:"red"})}b(a),S(c),f({id:"",property_id:e,renter_id:n,description:"",request_date:new Date().toISOString(),status:"pending"}),j(!0)},V=async e=>{const n=T.find(a=>a.id===e);if(!n||!z(n)){d.show({title:"Error",message:"No autorizado para eliminar.",color:"red"});return}try{await I.delete(e),E(),d.show({title:"Éxito",message:"Solicitud eliminada.",color:"green"})}catch{d.show({title:"Error",message:"Error al eliminar.",color:"red"})}},W=e=>{const n=g.find(a=>a.id===e);return n?n.address:"Desconocido"},X=e=>{const n=p.find(a=>a.id===e);return n?n.full_name:"Desconocido"},Y=e=>{switch(e==null?void 0:e.toLowerCase()){case"pending":return"yellow";case"in progress":case"in_progress":return"blue";case"completed":return"green";case"cancelled":return"red";default:return"gray"}},Z=e=>{switch(e==null?void 0:e.toLowerCase()){case"pending":return"Pendiente";case"in progress":case"in_progress":return"En Progreso";case"completed":return"Completado";case"cancelled":return"Cancelado";default:return e||"Desconocido"}},$=async()=>{if(!i||!i.description){d.show({title:"Error",message:"La descripción es requerida.",color:"red"});return}if(!i.property_id&&(s||l)){d.show({title:"Error",message:"La propiedad es requerida para administradores/encargados.",color:"red"});return}if(h&&(r!=null&&r.person_id))if(!i.id||i.renter_id===r.person_id)i.renter_id=r.person_id;else{d.show({title:"Error",message:"No puede cambiar el solicitante de esta petición.",color:"red"});return}const e={...i,request_date:i.request_date?new Date(i.request_date).toISOString():new Date().toISOString()};try{if(e.id)await I.update(e.id,e),d.show({title:"Éxito",message:"Solicitud actualizada.",color:"green"});else{const{id:n,...a}=e;await I.create(a),d.show({title:"Éxito",message:"Solicitud creada.",color:"green"})}E(),j(!1)}catch(n){console.error("Error saving maintenance request:",n),d.show({title:"Error",message:"Error al guardar.",color:"red"})}},ee=s||l||h;return t.jsxs(re,{size:"xl",children:[t.jsx(te,{visible:K||!r}),M&&t.jsxs(ne,{color:"red",children:["Error al cargar solicitudes: ",M.message]}),t.jsxs(v,{justify:"space-between",mb:"md",children:[t.jsx(ie,{order:1,children:"Solicitudes de Mantenimiento"}),t.jsxs(v,{children:[t.jsx(q,{leftSection:t.jsx(he,{size:16}),variant:"outline",onClick:()=>E(),children:"Actualizar"}),ee&&t.jsx(q,{leftSection:t.jsx(fe,{size:16}),onClick:J,"data-testid":"add-maintenance-request-button",children:"Nueva Solicitud"})]})]}),t.jsx(ae,{placeholder:"Buscar por descripción...",mb:"md",leftSection:t.jsx(ge,{size:16}),value:A,onChange:e=>k(e.currentTarget.value)}),t.jsxs(o,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[t.jsx(o.Thead,{children:t.jsxs(o.Tr,{children:[t.jsx(o.Th,{children:"Propiedad"}),t.jsx(o.Th,{children:"Solicitante"}),t.jsx(o.Th,{children:"Descripción"}),t.jsx(o.Th,{children:"Fecha"}),t.jsx(o.Th,{children:"Estado"}),t.jsx(o.Th,{children:"Acciones"})]})}),t.jsx(o.Tbody,{children:L.length===0?t.jsx(o.Tr,{children:t.jsx(o.Td,{colSpan:6,align:"center",children:"No se encontraron solicitudes"})}):L.map(e=>t.jsxs(o.Tr,{children:[t.jsx(o.Td,{children:W(e.property_id)}),t.jsx(o.Td,{children:X(e.renter_id)}),t.jsx(o.Td,{children:e.description}),t.jsx(o.Td,{children:new Date(e.request_date).toLocaleDateString()}),t.jsx(o.Td,{children:t.jsx(oe,{color:Y(e.status),children:Z(e.status)})}),t.jsx(o.Td,{children:t.jsxs(v,{gap:"xs",children:[H(e)&&t.jsx(F,{variant:"subtle",color:"blue",onClick:()=>U(e),children:t.jsx(me,{size:16})}),z(e)&&t.jsx(F,{variant:"subtle",color:"red",onClick:()=>V(e.id),children:t.jsx(xe,{size:16})})]})})]},e.id))})]}),y&&i&&t.jsxs(ue,{opened:y,onClose:()=>j(!1),title:i.id?"Editar Solicitud":"Nueva Solicitud",centered:!0,size:"lg",children:[t.jsx(D,{label:"Propiedad",placeholder:"Seleccione una propiedad",data:w.map(e=>({value:e.id,label:e.address})),value:i.property_id,onChange:e=>f(n=>({...n,property_id:e||""})),required:!0,disabled:h&&!!i.id,mb:"md"}),t.jsx(D,{label:"Solicitante (Inquilino)",placeholder:"Seleccione un inquilino",data:G.map(e=>({value:e.id,label:e.full_name})),value:i.renter_id,onChange:e=>f(n=>({...n,renter_id:e||""})),required:!0,disabled:h,mb:"md"}),t.jsx(se,{label:"Descripción",placeholder:"Describa el problema",required:!0,value:i.description,onChange:e=>{var a;const n=(a=e.currentTarget)==null?void 0:a.value;n!==void 0&&f(c=>({...c,description:n}))},disabled:l&&!!i.id&&i.renter_id!==(r==null?void 0:r.person_id),mb:"md",minRows:3}),t.jsx(de,{label:"Fecha de Solicitud",value:i.request_date?new Date(i.request_date):new Date,onChange:e=>f(n=>({...n,request_date:(e==null?void 0:e.toISOString())||new Date().toISOString()})),required:!0,disabled:!s&&!!i.id,mb:"md"}),t.jsx(D,{label:"Estado",placeholder:"Seleccione un estado",data:[{value:"pending",label:"Pendiente"},{value:"in_progress",label:"En Progreso"},{value:"completed",label:"Completado"},{value:"cancelled",label:"Cancelado"}],value:i.status,onChange:e=>f(n=>({...n,status:e||"pending"})),required:!0,disabled:!Q(i),mb:"xl"}),t.jsxs(v,{justify:"flex-end",children:[t.jsx(q,{variant:"outline",onClick:()=>j(!1),children:"Cancelar"}),t.jsx(q,{onClick:$,children:"Guardar"})]})]})]})}export{Ie as default};
