import{O as U,j as e,g as K,a as I,P as N,S as w,H as o,l as u,y as A,Q,z as F,E as J,x as P,G as E,B as p,F as W,b as k,n as d}from"./mantine-vendor-D4AgWXPI.js";import{r as h}from"./react-vendor-Q26-omST.js";import{u as M,a as S}from"./utils-vendor-CNi8B-Rx.js";import{f as X,p as Y,a as Z}from"./apiService-758Vinm-.js";import{j as ee,e as D,d as C,a as re}from"./index-cX4OG7Q0.js";import{I as ae}from"./IconSignature-BWCYSrH4.js";const R=S.create({baseURL:"/api",headers:{"Content-Type":"application/json"}});R.interceptors.request.use(s=>{const i=re.getToken();return console.log("Auth token from authService:",i),i&&(s.headers.Authorization=`Bearer ${i}`),s},s=>Promise.reject(s));const de=()=>{const[s,i]=h.useState(!1),[m,v]=h.useState(null),[T,c]=h.useState(!1),[$,y]=h.useState(!1),{data:x,isLoading:g}=M({queryKey:["personsForContract"],queryFn:Y.getAll}),{data:j,isLoading:z}=M({queryKey:["propertiesForContract"],queryFn:Z.getAll}),a=U({initialValues:{renter_id:"",owner_id:"",property_id:"",cosigner_id:"",start_date:null,end_date:null,contract_duration:"6",monthly_rent:0,requires_deposit:!1,deposit_amount:0,deposit_text:"El depósito será utilizado para cubrir cualquier renta no pagada o daños a la propiedad.",additional_info:""},validate:{renter_id:r=>r?null:"Arrendatario es requerido",owner_id:r=>r?null:"Arrendador es requerido",property_id:r=>r?null:"Propiedad es requerida",start_date:r=>r?null:"Fecha de inicio es requerida",monthly_rent:r=>r<=0?"El precio de renta mensual es requerido":null,deposit_amount:(r,t)=>t.requires_deposit&&r<=0?"El monto del depósito es requerido":null}}),b=x||[],f=x||[],_=x||[],q=(r,t)=>{if(!r)return null;const n=new Date(r);return n.setMonth(n.getMonth()+t),n},G=r=>{a.setFieldValue("contract_duration",r);const t=parseInt(r,10),n=q(a.values.start_date,t);a.setFieldValue("end_date",n)},L=r=>{if(a.setFieldValue("start_date",r),r){const t=parseInt(a.values.contract_duration,10),n=q(r,t);a.setFieldValue("end_date",n)}},B=async r=>{i(!0);try{const t=await R.post("/contracts/generate",r,{responseType:"blob"}),n=t.headers["x-contract-id"];n&&v(n);const V=new Blob([t.data],{type:"application/pdf"}),H=window.URL.createObjectURL(V),l=document.createElement("a");l.href=H,l.setAttribute("download","contrato_arrendamiento.pdf"),document.body.appendChild(l),l.click(),document.body.removeChild(l),d.show({title:"Contrato generado",message:"El contrato ha sido generado exitosamente",color:"green",icon:e.jsx(D,{})})}catch(t){console.error("Error generating contract:",t);let n="Ha ocurrido un error al generar el contrato.";S.isAxiosError(t)&&t.response&&(n=t.response.data.error||n),d.show({title:"Error",message:n,color:"red",icon:e.jsx(C,{})})}finally{i(!1)}},O=async()=>{if(!m||!a.values.renter_id){d.show({title:"Error",message:"No se puede solicitar firma sin generar un contrato primero",color:"red",icon:e.jsx(C,{})});return}y(!0);try{await X.requestSignature({contract_id:m,recipient_id:a.values.renter_id,expiration_days:7}),d.show({title:"Solicitud de firma enviada",message:"El correo electrónico con la solicitud de firma ha sido enviado correctamente",color:"green",icon:e.jsx(D,{})}),a.reset(),v(null),c(!1)}catch(r){console.error("Error requesting signature:",r);let t="Ha ocurrido un error al solicitar la firma.";S.isAxiosError(r)&&r.response&&(t=r.response.data.error||t),d.show({title:"Error",message:t,color:"red",icon:e.jsx(C,{})})}finally{y(!1)}};return e.jsxs(K,{children:[e.jsx(I,{order:2,mb:"md",children:"Generación de Contratos de Arrendamiento"}),e.jsx(N,{shadow:"xs",p:"md",withBorder:!0,children:e.jsx("form",{onSubmit:a.onSubmit(B),children:e.jsxs(w,{children:[e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(u,{label:"Arrendatario",description:"Persona que alquilará la propiedad",data:(b==null?void 0:b.map(r=>({value:r.id,label:`${r.full_name} (${r.nit})`})))||[],placeholder:"Seleccione el arrendatario",searchable:!0,withAsterisk:!0,disabled:g,...a.getInputProps("renter_id")})}),e.jsx(o.Col,{span:6,children:e.jsx(u,{label:"Arrendador",description:"Propietario de la propiedad",data:(f==null?void 0:f.map(r=>({value:r.id,label:`${r.full_name} (${r.nit})`})))||[],placeholder:"Seleccione el arrendador",searchable:!0,withAsterisk:!0,disabled:g,...a.getInputProps("owner_id")})})]}),e.jsx(o,{children:e.jsx(o.Col,{span:12,children:e.jsx(u,{label:"Propiedad",description:"Propiedad que será arrendada",data:(j==null?void 0:j.map(r=>({value:r.id,label:`${r.address} (${r.type})`})))||[],placeholder:"Seleccione la propiedad",searchable:!0,withAsterisk:!0,disabled:z,...a.getInputProps("property_id")})})}),e.jsx(o,{children:e.jsx(o.Col,{span:12,children:e.jsx(u,{label:"Deudor Solidario (Opcional)",description:"Persona que responderá como garantía adicional",data:(_==null?void 0:_.map(r=>({value:r.id,label:`${r.full_name} (${r.nit})`})))||[],placeholder:"Seleccione el deudor solidario (opcional)",searchable:!0,disabled:g,clearable:!0,...a.getInputProps("cosigner_id")})})}),e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(A,{label:"Fecha de Inicio",description:"Fecha en que inicia el contrato",placeholder:"Seleccione la fecha de inicio",withAsterisk:!0,value:a.values.start_date,onChange:L,error:a.errors.start_date})}),e.jsx(o.Col,{span:6,children:e.jsxs(w,{gap:"xs",children:[e.jsx(I,{order:6,children:"Duración del Contrato"}),e.jsx(Q,{data:[{label:"6 Meses",value:"6"},{label:"12 Meses",value:"12"},{label:"24 Meses",value:"24"}],value:a.values.contract_duration,onChange:G}),e.jsx(A,{label:"Fecha de Finalización",description:"Calculada automáticamente según duración",placeholder:"Fecha de finalización",value:a.values.end_date,disabled:!0})]})})]}),e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(F,{label:"Renta Mensual",description:"Monto a pagar mensualmente",placeholder:"Ingrese el monto de la renta",withAsterisk:!0,min:0,...a.getInputProps("monthly_rent")})}),e.jsx(o.Col,{span:6,children:e.jsx(J,{label:"Requiere Depósito",description:"Marque si se requiere un depósito de garantía",checked:a.values.requires_deposit,onChange:r=>a.setFieldValue("requires_deposit",r.currentTarget.checked),mt:"md"})})]}),a.values.requires_deposit&&e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(F,{label:"Monto de Depósito",description:"Monto del depósito de garantía",placeholder:"Ingrese el monto del depósito",withAsterisk:!0,min:0,...a.getInputProps("deposit_amount")})}),e.jsx(o.Col,{span:6,children:e.jsx(P,{label:"Texto del Depósito",description:"Descripción de las condiciones del depósito",placeholder:"Ingrese el texto sobre las condiciones del depósito",...a.getInputProps("deposit_text")})})]}),e.jsx(P,{label:"Información Adicional (Opcional)",description:"Cláusulas adicionales u observaciones para el contrato",placeholder:"Ingrese información adicional para el contrato",minRows:4,maxRows:8,...a.getInputProps("additional_info")}),e.jsx(o,{mt:"md",children:e.jsx(o.Col,{children:e.jsxs(E,{children:[e.jsx(p,{leftSection:e.jsx(ee,{}),type:"submit",loading:s,disabled:s,children:"Generar Contrato PDF"}),m&&e.jsx(p,{leftSection:e.jsx(ae,{}),color:"blue",onClick:()=>c(!0),disabled:s,children:"Solicitar Firma"})]})})})]})})}),e.jsxs(W,{opened:T,onClose:()=>c(!1),title:"Solicitar Firma de Contrato",children:[e.jsx(k,{size:"sm",mb:"md",children:"Está a punto de enviar una solicitud de firma electrónica al arrendatario. Se le enviará un correo electrónico con un enlace para revisar y firmar el contrato."}),e.jsx(k,{size:"sm",mb:"md",children:"El enlace de firma estará activo por 7 días."}),e.jsxs(E,{justify:"space-between",mt:"xl",children:[e.jsx(p,{variant:"outline",onClick:()=>c(!1),children:"Cancelar"}),e.jsx(p,{loading:$,onClick:O,children:"Confirmar y Enviar"})]})]})]})};export{de as default};
