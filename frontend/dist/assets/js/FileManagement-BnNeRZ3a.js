import{a1 as he,f as me,j as e,C as ue,a as xe,G as d,F as S,o as A,b as r,P as X,B as g,k as je,l as Z,m as pe,L as ge,q as i,r as k,Z as E,e as C,E as ve,S as we,p as fe,n as x}from"./mantine-vendor-Bripv_3X.js";import{r as c}from"./react-vendor-Cmr1RT9l.js";import{c as ee,o as L,I as ze,n as I,p as be,g as ye}from"./index-BGAR1JXy.js";import{I as Se}from"./IconSearch-f2W8sUQc.js";import{I as ke}from"./IconFilter-BpFZB46E.js";import{I as j}from"./IconDownload-CF5TjiM4.js";import{I as Ee}from"./IconEye-BVgdW_qg.js";import{I as J}from"./IconTrash-C4TwLzKL.js";import{I as Q,a as Ce}from"./IconPhoto-Dtm8nmsQ.js";import"./utils-vendor-tZ1hTSV2.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Y=ee("outline","cloud","IconCloud",[["path",{d:"M6.657 18c-2.572 0 -4.657 -2.007 -4.657 -4.483c0 -2.475 2.085 -4.482 4.657 -4.482c.393 -1.762 1.794 -3.2 3.675 -3.773c1.88 -.572 3.956 -.193 5.444 1c1.488 1.19 2.162 3.007 1.77 4.769h.99c1.913 0 3.464 1.56 3.464 3.486c0 1.927 -1.551 3.487 -3.465 3.487h-11.878",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ie=ee("outline","database","IconDatabase",[["path",{d:"M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0",key:"svg-0"}],["path",{d:"M4 6v6a8 3 0 0 0 16 0v-6",key:"svg-1"}],["path",{d:"M4 12v6a8 3 0 0 0 16 0v-6",key:"svg-2"}]]);const Pe=()=>{const v=he(),[B,se]=c.useState([]),[T,_]=c.useState([]),[D,M]=c.useState(!0),[n,re]=c.useState(null),[oe,{open:ae,close:w}]=me(!1),[F,p]=c.useState(null),[f,R]=c.useState("all"),[z,P]=c.useState(""),[b,N]=c.useState("all"),[O,ie]=c.useState(0),[te,ne]=c.useState(0),[$,le]=c.useState([]),y=async()=>{try{M(!0);const s=localStorage.getItem("auth_token"),o=await fetch("/api/admin/file-upload/files",{headers:{Authorization:`Bearer ${s}`}});if(!o.ok)throw new Error("Error cargando archivos");const t=(await o.json()).files||[];se(t),_(t),ie(t.length),ne(t.reduce((u,h)=>u+h.size,0));const m=Array.from(new Set(t.map(u=>{var l;return((l=u.path.split("/")[0])==null?void 0:l.replace("user_",""))||"unknown"})));le(m)}catch(s){console.error("Error:",s),x.show({title:"Error",message:"No se pudieron cargar los archivos",color:"red",icon:e.jsx(I,{size:16})})}finally{M(!1)}};c.useEffect(()=>{let s=B;f!=="all"&&(s=s.filter(o=>{const a=o.mime_type||"";switch(f){case"images":return a.startsWith("image/");case"documents":return a.includes("pdf")||a.includes("doc")||a.includes("text");case"archives":return a.includes("zip")||a.includes("rar");default:return!0}})),b!=="all"&&(s=s.filter(o=>{var t;return(((t=o.path.split("/")[0])==null?void 0:t.replace("user_",""))||"unknown")===b})),z&&(s=s.filter(o=>o.name.toLowerCase().includes(z.toLowerCase()))),_(s)},[B,f,b,z]);const G=async s=>{try{p(s);const o=localStorage.getItem("auth_token"),a=encodeURIComponent(s);if(!(await fetch(`/api/admin/file-upload/files/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}})).ok)throw new Error("Error eliminando archivo");x.show({title:"🗑️ Archivo Eliminado",message:"El archivo ha sido eliminado exitosamente",color:"green",icon:e.jsx(ye,{size:16})}),await y()}catch(o){console.error("Error:",o),x.show({title:"Error",message:"No se pudo eliminar el archivo",color:"red",icon:e.jsx(I,{size:16})})}finally{p(null)}},W=async(s,o)=>{try{p(s);const a=localStorage.getItem("auth_token"),t=encodeURIComponent(s),m=await fetch(`/api/admin/file-upload/files/download-only/${t}`,{headers:{Authorization:`Bearer ${a}`}});if(!m.ok)throw new Error("Error descargando archivo");const u=await m.blob(),h=window.URL.createObjectURL(u),l=document.createElement("a");l.href=h,l.download=o,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(h),document.body.removeChild(l),x.show({title:"📥 Archivo Descargado",message:"El archivo se descargó (sin eliminar de Supabase)",color:"blue",icon:e.jsx(j,{size:16})})}catch(a){console.error("Error:",a),x.show({title:"Error",message:"No se pudo descargar el archivo",color:"red",icon:e.jsx(I,{size:16})})}finally{p(null)}},q=async(s,o)=>{try{p(s);const a=localStorage.getItem("auth_token"),t=encodeURIComponent(s),m=await fetch(`/api/admin/file-upload/files/download/${t}`,{headers:{Authorization:`Bearer ${a}`}});if(!m.ok)throw new Error("Error descargando archivo");const u=await m.blob(),h=window.URL.createObjectURL(u),l=document.createElement("a");l.href=h,l.download=o,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(h),document.body.removeChild(l),x.show({title:"📥 Archivo Descargado y Eliminado",message:"El archivo se descargó y se eliminó automáticamente de Supabase",color:"green",icon:e.jsx(j,{size:16})}),await y()}catch(a){console.error("Error:",a),x.show({title:"Error",message:"No se pudo descargar el archivo",color:"red",icon:e.jsx(I,{size:16})})}finally{p(null)}},U=s=>{if(s===0)return"0 Bytes";const o=1024,a=["Bytes","KB","MB","GB"],t=Math.floor(Math.log(s)/Math.log(o));return parseFloat((s/Math.pow(o,t)).toFixed(2))+" "+a[t]},K=s=>new Date(s).toLocaleString("es-ES"),H=s=>{var a;return((a=s.split("/")[0])==null?void 0:a.replace("user_",""))||"unknown"},ce=s=>s.startsWith("image/")?e.jsx(Ce,{size:16}):s.includes("pdf")?e.jsx(be,{size:16}):e.jsx(Q,{size:16}),V=s=>s.startsWith("image/")?"blue":s.includes("pdf")?"red":s.includes("doc")?"cyan":s.includes("zip")||s.includes("rar")?"orange":"gray",de=s=>{re(s),ae()};return c.useEffect(()=>{y()},[]),e.jsxs(ue,{size:"xl",py:"md",children:[e.jsx(xe,{order:2,mb:"md",children:e.jsxs(d,{children:[e.jsx(Y,{size:28,color:v.colors.blue[6]}),"Gestión de Archivos - Supabase Storage"]})}),e.jsxs(S,{mb:"md",children:[e.jsx(S.Col,{span:{base:12,md:4},children:e.jsx(A,{shadow:"sm",padding:"lg",radius:"md",withBorder:!0,children:e.jsxs(d,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Total de Archivos"}),e.jsx(r,{size:"xl",fw:700,children:O})]}),e.jsx(Ie,{size:32,color:v.colors.blue[6]})]})})}),e.jsx(S.Col,{span:{base:12,md:4},children:e.jsx(A,{shadow:"sm",padding:"lg",radius:"md",withBorder:!0,children:e.jsxs(d,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Espacio Utilizado"}),e.jsx(r,{size:"xl",fw:700,children:U(te)})]}),e.jsx(Y,{size:32,color:v.colors.green[6]})]})})}),e.jsx(S.Col,{span:{base:12,md:4},children:e.jsx(A,{shadow:"sm",padding:"lg",radius:"md",withBorder:!0,children:e.jsxs(d,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Usuarios Activos"}),e.jsx(r,{size:"xl",fw:700,children:$.length})]}),e.jsx(L,{size:32,color:v.colors.orange[6]})]})})})]}),e.jsxs(X,{shadow:"sm",p:"md",mb:"md",children:[e.jsxs(d,{justify:"space-between",mb:"md",children:[e.jsx(r,{fw:500,children:"Filtros"}),e.jsx(g,{variant:"subtle",size:"xs",onClick:()=>{R("all"),N("all"),P("")},children:"Limpiar Filtros"})]}),e.jsxs(d,{grow:!0,children:[e.jsx(je,{placeholder:"Buscar archivos...",value:z,onChange:s=>P(s.target.value),leftSection:e.jsx(Se,{size:16})}),e.jsx(Z,{placeholder:"Tipo de archivo",value:f,onChange:s=>R(s||"all"),data:[{value:"all",label:"Todos los tipos"},{value:"images",label:"Imágenes"},{value:"documents",label:"Documentos"},{value:"archives",label:"Archivos comprimidos"}],leftSection:e.jsx(ke,{size:16})}),e.jsx(Z,{placeholder:"Usuario",value:b,onChange:s=>N(s||"all"),data:[{value:"all",label:"Todos los usuarios"},...$.map(s=>({value:s,label:s}))],leftSection:e.jsx(L,{size:16})})]})]}),e.jsx(pe,{icon:e.jsx(ze,{size:16}),title:"Información Importante",color:"blue",mb:"md",children:e.jsxs(r,{size:"sm",children:["Los archivos están almacenados en ",e.jsx("strong",{children:"Supabase Storage"})," con límite de 1GB. Cuando un administrador descarga un archivo, se ",e.jsx("strong",{children:"elimina automáticamente"})," de Supabase."]})}),e.jsxs(X,{shadow:"sm",p:"md",pos:"relative",children:[e.jsx(ge,{visible:D}),e.jsxs(d,{justify:"space-between",mb:"md",children:[e.jsxs(r,{fw:500,children:["Archivos (",T.length,"/",O,")"]}),e.jsx(g,{variant:"light",leftSection:e.jsx(j,{size:16}),onClick:y,loading:D,children:"Actualizar"})]}),T.length===0?e.jsx(r,{ta:"center",c:"dimmed",py:"xl",children:"No hay archivos para mostrar"}):e.jsx(i.ScrollContainer,{minWidth:800,children:e.jsxs(i,{verticalSpacing:"md",highlightOnHover:!0,children:[e.jsx(i.Thead,{children:e.jsxs(i.Tr,{children:[e.jsx(i.Th,{children:"Archivo"}),e.jsx(i.Th,{children:"Usuario"}),e.jsx(i.Th,{children:"Tamaño"}),e.jsx(i.Th,{children:"Tipo"}),e.jsx(i.Th,{children:"Fecha"}),e.jsx(i.Th,{children:"Acciones"})]})}),e.jsx(i.Tbody,{children:T.map(s=>{var o;return e.jsxs(i.Tr,{children:[e.jsx(i.Td,{children:e.jsxs(d,{gap:"sm",children:[ce(s.mime_type),e.jsxs("div",{children:[e.jsx(r,{size:"sm",fw:500,children:s.name}),e.jsx(r,{size:"xs",c:"dimmed",children:s.path})]})]})}),e.jsx(i.Td,{children:e.jsx(k,{variant:"light",color:"blue",leftSection:e.jsx(L,{size:12}),children:H(s.path)})}),e.jsx(i.Td,{children:e.jsx(r,{size:"sm",children:U(s.size)})}),e.jsx(i.Td,{children:e.jsx(k,{variant:"light",color:V(s.mime_type),children:((o=s.mime_type.split("/")[1])==null?void 0:o.toUpperCase())||"UNKNOWN"})}),e.jsx(i.Td,{children:e.jsx(r,{size:"sm",children:K(s.uploaded_at)})}),e.jsx(i.Td,{children:e.jsxs(d,{gap:"xs",children:[e.jsx(E,{label:"Ver detalles",children:e.jsx(C,{variant:"light",color:"blue",onClick:()=>de(s),children:e.jsx(Ee,{size:16})})}),e.jsx(E,{label:"Descargar",children:e.jsx(C,{variant:"light",color:"blue",loading:F===s.path,onClick:()=>W(s.path,s.name),children:e.jsx(j,{size:16})})}),e.jsx(E,{label:"Descargar y Eliminar",children:e.jsx(C,{variant:"light",color:"green",loading:F===s.path,onClick:()=>q(s.path,s.name),children:e.jsx(j,{size:16})})}),e.jsx(E,{label:"Eliminar",children:e.jsx(C,{variant:"light",color:"red",loading:F===s.path,onClick:()=>G(s.path),children:e.jsx(J,{size:16})})})]})})]},s.path)})})]})})]}),e.jsx(ve,{opened:oe,onClose:w,title:e.jsxs(d,{children:[e.jsx(Q,{size:20}),e.jsx(r,{fw:500,children:"Detalles del Archivo"})]}),size:"md",children:n&&e.jsxs(we,{gap:"md",children:[e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Nombre del archivo"}),e.jsx(r,{fw:500,children:n.name})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Ruta completa"}),e.jsx(r,{size:"sm",ff:"monospace",children:n.path})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Usuario"}),e.jsx(k,{variant:"light",color:"blue",children:H(n.path)})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Tamaño"}),e.jsx(r,{children:U(n.size)})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Tipo MIME"}),e.jsx(k,{variant:"light",color:V(n.mime_type),children:n.mime_type})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"Fecha de subida"}),e.jsx(r,{children:K(n.uploaded_at)})]}),e.jsxs("div",{children:[e.jsx(r,{size:"sm",c:"dimmed",children:"URL de descarga"}),e.jsx(fe,{href:n.download_url,target:"_blank",size:"sm",style:{wordBreak:"break-all"},children:n.download_url})]}),e.jsxs(d,{mt:"md",children:[e.jsx(g,{variant:"light",color:"blue",leftSection:e.jsx(j,{size:16}),onClick:()=>{W(n.path,n.name),w()},children:"Descargar"}),e.jsx(g,{variant:"light",color:"green",leftSection:e.jsx(j,{size:16}),onClick:()=>{q(n.path,n.name),w()},children:"Descargar y Eliminar"}),e.jsx(g,{variant:"light",color:"red",leftSection:e.jsx(J,{size:16}),onClick:()=>{G(n.path),w()},children:"Solo Eliminar"})]})]})})]})};export{Pe as default};
