import{f as L,j as r,C as de,G as p,T as ce,a as ue,B as f,P as he,L as pe,b as fe,q as l,r as xe,e as A,S as B,l as w,w as q,k as ge,n as h}from"./mantine-vendor-Bripv_3X.js";import{u as me,d as je}from"./index-BGAR1JXy.js";import{r as n}from"./react-vendor-Cmr1RT9l.js";import{c as T,p as be,r as Se,a as ve}from"./apiService-19GZqUtM.js";import{S as N}from"./StableModal-BsXR2I9w.js";import{I as De}from"./IconFilter-BpFZB46E.js";import{I as we,a as Te}from"./IconPlus-dymNjJLj.js";import{I as Ce}from"./IconEye-BVgdW_qg.js";import{I as _e}from"./IconTrash-C4TwLzKL.js";import"./utils-vendor-tZ1hTSV2.js";function Re(){const{user:d}=me(),s=(d==null?void 0:d.role)==="admin",[C,_]=n.useState([]),[E,V]=n.useState([]),[P,H]=n.useState([]),[G,$]=n.useState([]),[y,c]=n.useState(!0),[U,{open:F,close:g}]=L(!1),[a,u]=n.useState(null),[o,I]=n.useState(!1),[Z,m]=L(!1),[j,z]=n.useState(null),[b,M]=n.useState(null),[S,O]=n.useState(""),v=async()=>{if(!d){_([]),c(!1);return}c(!0);try{let e,t;s&&(S?t={status:S}:j&&b&&(t={startDate:j.toISOString(),endDate:b.toISOString()})),e=await T.getForCurrentUser(d,t),_(e)}catch(e){console.error("Failed to fetch rental histories:",e),h.show({title:"Error",message:"Error al cargar datos de historial de alquileres",color:"red"}),_([])}finally{c(!1)}},J=async()=>{c(!0);try{const[e,t,i]=await Promise.all([be.getAll(),Se.getAll(),ve.getAll()]);V(e),H(t),$(i)}catch(e){console.error("Failed to fetch related data:",e)}finally{}};n.useEffect(()=>{d&&(v(),(s||d.role==="manager")&&J())},[d,S,j,b]);const K=e=>{u(e),I(!0),F()},Q=e=>{s&&(u(e),I(!1),F())},W=()=>{s&&(u({person_id:"",rental_id:"",status:"",end_reason:"",end_date:new Date().toISOString()}),I(!1),F())},X=async e=>{if(s&&confirm("¿Está seguro que desea eliminar este registro de historial?")){c(!0);try{await T.delete(e),h.show({title:"Éxito",message:"Registro de historial eliminado correctamente",color:"green"}),v()}catch(t){console.error("Failed to delete history record:",t),h.show({title:"Error",message:"Error al eliminar el registro de historial",color:"red"})}finally{c(!1)}}},ee=async()=>{var e,t;if(o){g();return}if(s){if(!a||!a.person_id||!a.rental_id||!a.status){h.show({title:"Error de Validación",message:"Por favor complete todos los campos requeridos (Persona, Alquiler, Estado).",color:"red"});return}c(!0);try{const i={...a,end_date:a.end_date?typeof a.end_date=="string"&&a.end_date.includes("T")?a.end_date:new Date(a.end_date).toISOString().split("T")[0]+"T00:00:00Z":new Date().toISOString()};i.id?(await T.update(i.id,i),h.show({title:"Éxito",message:"Registro de historial actualizado.",color:"green"})):(await T.create(i),h.show({title:"Éxito",message:"Registro de historial creado.",color:"green"})),g(),v()}catch(i){console.error("Failed to save history record:",i);const D=((t=(e=i.response)==null?void 0:e.data)==null?void 0:t.error)||"Error al guardar el registro.";h.show({title:"Error",message:D,color:"red"})}finally{c(!1)}}},re=()=>{s&&(v(),m.close())},ae=()=>{s&&(z(null),M(null),O(""),m.close())},te=e=>{if(!e)return"N/A";try{return new Date(e).toLocaleDateString()}catch{return"Fecha Inválida"}},se=e=>{const t=E.find(i=>i.id===e);return t?t.full_name:e?"ID: "+e.substring(0,8):"Desconocido"},R=e=>{const t=P.find(x=>x.id===e);if(!t)return e?"Alquiler ID: "+e.substring(0,8):"Desconocido";const i=G.find(x=>x.id===t.property_id),D=E.find(x=>x.id===t.renter_id);let k=`Alquiler de ${D?D.full_name:"inquilino desconocido"}`;return i&&(k+=` en ${i.address}`),k},le=(e="")=>{switch(e==null?void 0:e.toLowerCase()){case"active":return"green";case"terminated":return"red";case"expired":return"orange";case"pending":return"blue";default:return"gray"}},ie=(e="")=>{switch(e==null?void 0:e.toLowerCase()){case"active":return"Activo";case"terminated":return"Terminado";case"expired":return"Expirado";case"pending":return"Pendiente";default:return e}},ne=s?E.map(e=>({value:e.id,label:e.full_name})):[],oe=s?P.map(e=>({value:e.id,label:R(e.id)})):[],Y=[{value:"active",label:"Activo"},{value:"terminated",label:"Terminado"},{value:"expired",label:"Expirado"},{value:"pending",label:"Pendiente"}];return r.jsxs(de,{fluid:!0,children:[r.jsxs(p,{justify:"space-between",mb:"lg",children:[r.jsxs(p,{children:[r.jsx(ce,{size:"xl",radius:"md",variant:"gradient",gradient:{from:"cyan",to:"blue"},children:r.jsx(je,{size:28})}),r.jsx(ue,{order:2,children:"Historial de Alquileres"})]}),r.jsxs(p,{children:[s&&r.jsx(f,{leftSection:r.jsx(De,{size:14}),onClick:m.open,variant:"outline",children:"Filtrar"}),s&&r.jsx(f,{leftSection:r.jsx(we,{size:14}),onClick:W,children:"Nuevo Historial"})]})]}),r.jsxs(he,{shadow:"sm",p:"md",withBorder:!0,children:[r.jsx(pe,{visible:y}),C.length===0&&!y&&r.jsx(fe,{ta:"center",p:"lg",children:"No hay registros de historial para mostrar."}),C.length>0&&r.jsxs(l,{striped:!0,highlightOnHover:!0,verticalSpacing:"sm",children:[r.jsx(l.Thead,{children:r.jsxs(l.Tr,{children:[r.jsx(l.Th,{children:"Persona"}),r.jsx(l.Th,{children:"Alquiler (Propiedad)"}),r.jsx(l.Th,{children:"Estado"}),r.jsx(l.Th,{children:"Fecha Fin"}),r.jsx(l.Th,{children:"Razón Fin"}),r.jsx(l.Th,{children:"Acciones"})]})}),r.jsx(l.Tbody,{children:C.map(e=>r.jsxs(l.Tr,{children:[r.jsx(l.Td,{children:se(e.person_id)}),r.jsx(l.Td,{children:R(e.rental_id)}),r.jsx(l.Td,{children:r.jsx(xe,{color:le(e.status),variant:"light",children:ie(e.status)})}),r.jsx(l.Td,{children:te(e.end_date)}),r.jsx(l.Td,{children:e.end_reason||"-"}),r.jsx(l.Td,{children:r.jsxs(p,{gap:"xs",wrap:"nowrap",children:[r.jsx(A,{variant:"subtle",color:"blue",onClick:()=>K(e),title:"Ver Detalles",children:r.jsx(Ce,{size:18})}),s&&r.jsx(A,{variant:"subtle",color:"yellow",onClick:()=>Q(e),title:"Editar",children:r.jsx(Te,{size:18})}),s&&r.jsx(A,{variant:"subtle",color:"red",onClick:()=>X(e.id),title:"Eliminar",children:r.jsx(_e,{size:18})})]})})]},e.id))})]})]}),s&&r.jsx(N,{opened:Z,onClose:m.close,title:"Filtrar Historial",children:r.jsxs(B,{children:[r.jsx(w,{label:"Estado",placeholder:"Seleccione un estado",data:Y,value:S,onChange:e=>O(e||""),clearable:!0}),r.jsx(q,{label:"Fecha de Inicio (Rango)",value:j,onChange:z,placeholder:"YYYY-MM-DD",clearable:!0}),r.jsx(q,{label:"Fecha de Fin (Rango)",value:b,onChange:M,placeholder:"YYYY-MM-DD",clearable:!0}),r.jsxs(p,{justify:"flex-end",mt:"md",children:[r.jsx(f,{variant:"default",onClick:ae,children:"Limpiar"}),r.jsx(f,{onClick:re,children:"Aplicar Filtros"})]})]})}),r.jsx(N,{opened:U,onClose:g,title:o?"Detalles del Historial":a!=null&&a.id?"Editar Historial":"Nuevo Historial",size:"lg",children:r.jsxs(B,{gap:"md",children:[r.jsx(w,{label:"Persona",placeholder:"Seleccione una persona",data:ne,value:(a==null?void 0:a.person_id)||"",onChange:e=>u(t=>({...t,person_id:e||""})),disabled:o||!s,required:!0,searchable:!0}),r.jsx(w,{label:"Alquiler (Inquilino en Propiedad)",placeholder:"Seleccione un alquiler",data:oe,value:(a==null?void 0:a.rental_id)||"",onChange:e=>u(t=>({...t,rental_id:e||""})),disabled:o||!s,required:!0,searchable:!0}),r.jsx(w,{label:"Estado",placeholder:"Seleccione un estado",data:Y,value:(a==null?void 0:a.status)||"",onChange:e=>u(t=>({...t,status:e||""})),disabled:o||!s,required:!0}),r.jsx(q,{label:"Fecha de Fin",value:a!=null&&a.end_date?new Date(a.end_date):null,onChange:e=>u(t=>({...t,end_date:e?e.toISOString().split("T")[0]:""})),placeholder:"YYYY-MM-DD",disabled:o||!s,required:!0}),r.jsx(ge,{label:"Razón de Finalización",placeholder:"Ej: Contrato finalizado, Mudanza, etc.",value:(a==null?void 0:a.end_reason)||"",onChange:e=>u(t=>({...t,end_reason:e.currentTarget.value})),disabled:o||!s}),r.jsxs(p,{justify:"flex-end",mt:"md",children:[r.jsx(f,{variant:"default",onClick:g,children:o||!s?"Cerrar":"Cancelar"}),!o&&s&&r.jsx(f,{onClick:ee,children:"Guardar Historial"})]})]})})]})}export{Re as default};
