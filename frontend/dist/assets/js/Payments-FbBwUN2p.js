import{f as te,j as e,C as ne,L as se,b as N,G as g,a as z,B as x,P as ie,T as oe,r as s,s as le,e as L,l as de,y as I,z as ce,E as M,n as u}from"./mantine-vendor-D4AgWXPI.js";import{c as ue,u as pe}from"./index-cX4OG7Q0.js";import{r as m}from"./react-vendor-Q26-omST.js";import{b as P,r as me,a as he,p as ge}from"./apiService-758Vinm-.js";import{S as O}from"./StableModal-C60p4KRL.js";import{c as xe,u as C}from"./utils-vendor-CNi8B-Rx.js";import{I as fe}from"./IconFilter-CqFxLFPY.js";import{I as ye,a as je}from"./IconPlus-BOpu3o19.js";import{I as be}from"./IconCreditCard-q0lNzg_i.js";import{I as _e}from"./IconTrash-cT-LP-1K.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Pe=ue("outline","receipt","IconReceipt",[["path",{d:"M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2m4 -14h6m-6 4h6m-2 4h2",key:"svg-0"}]]);function Fe(){const{user:r}=pe(),q=xe(),t=(r==null?void 0:r.role)==="admin",i=(r==null?void 0:r.role)==="manager",f=!t&&!i,{data:w=[],isLoading:D,error:v,refetch:R}=C({queryKey:["payments",r==null?void 0:r.id,r==null?void 0:r.role,r==null?void 0:r.person_id],queryFn:()=>P.getForCurrentUser(r),enabled:!!r}),{data:p=[],isLoading:G}=C({queryKey:["allRentalsGlobalForPayments"],queryFn:me.getAll,enabled:t||i}),{data:y=[],isLoading:$}=C({queryKey:["allPropertiesGlobalForPayments"],queryFn:he.getAll,enabled:t||i}),{data:E=[]}=C({queryKey:["allPersonsForPayments"],queryFn:ge.getAll,enabled:t||i}),[b,T]=m.useState([]),[F,j]=m.useState(!1),[o,h]=m.useState(null),[K,A]=te(!1),[B,H]=m.useState(null),[Q,U]=m.useState(null),[J,V]=m.useState(!1);m.useEffect(()=>{if(!(!r||!r.person_id)){if(t)T(p);else if(i&&r.person_id){const a=y.filter(n=>{var d;return(d=n.manager_ids)==null?void 0:d.includes(r.person_id)}).map(n=>n.id),l=p.filter(n=>a.includes(n.property_id));T(l)}}},[r,t,i,p,y]);const _=a=>{var l;if(!r)return!1;if(t)return!0;if(i&&r.person_id){if(!a||!a.rental_id)return!0;const n=p.find(c=>c.id===a.rental_id);if(!n)return!1;const d=y.find(c=>c.id===n.property_id);return((l=d==null?void 0:d.manager_ids)==null?void 0:l.includes(r.person_id))??!1}return!1},W=async a=>{_(a)&&(h(a),j(!0))},X=async()=>{!t&&!i||(t&&b.length===0&&p.length>0&&T(p),h({rental_id:b.length>0?b[0].id:"",payment_date:new Date().toISOString(),amount_paid:0,paid_on_time:!0}),j(!0))},Y=async a=>{if(!_(a)){u.show({title:"Error",message:"No autorizado para eliminar.",color:"red"});return}if(confirm("¿Está seguro que desea eliminar este pago?"))try{await P.delete(a.id),R(),q.invalidateQueries({queryKey:["payments",r==null?void 0:r.id,r==null?void 0:r.role,r==null?void 0:r.person_id]}),u.show({title:"Éxito",message:"Pago eliminado.",color:"green"})}catch{u.show({title:"Error",message:"Error al eliminar el pago.",color:"red"})}},Z=async()=>{if(!o||!o.rental_id){u.show({title:"Error",message:"Alquiler es requerido.",color:"red"});return}if(!_(o)){u.show({title:"Error",message:"No autorizado para guardar este pago.",color:"red"});return}const a={...o,payment_date:o.payment_date?new Date(o.payment_date).toISOString():new Date().toISOString()};try{if(a.id)await P.update(a.id,a),u.show({title:"Éxito",message:"Pago actualizado.",color:"green"});else{const{id:l,...n}=a;await P.create(n),u.show({title:"Éxito",message:"Pago creado.",color:"green"})}q.invalidateQueries({queryKey:["payments",r==null?void 0:r.id,r==null?void 0:r.role,r==null?void 0:r.person_id]}),j(!1)}catch{u.show({title:"Error",message:"Error al guardar pago.",color:"red"})}},k=a=>a?new Date(a).toLocaleDateString():"N/A",ee=a=>{const l=p.find(c=>c.id===a.rental_id);if(!l)return{propertyAddress:"Alquiler no encontrado",renterName:"N/A"};const n=y.find(c=>c.id===l.property_id),d=E.find(c=>c.id===l.renter_id);return{propertyAddress:n?`${n.address}${n.apt_number?", "+n.apt_number:""}, ${n.city}`:"Propiedad desconocida",renterName:d?d.full_name:"Inquilino Desconocido"}},ae=a=>{const l=y.find(S=>S.id===a.property_id),n=E.find(S=>S.id===a.renter_id),d=l?`${l.address.substring(0,15)}..`:"Propiedad desc.",c=n?n.full_name:"Inquilino desc.";return`${d} - ${c} (Fin: ${k(a.end_date)})`},re=D||(t||i)&&(G||$);return e.jsxs(ne,{size:"xl",children:[e.jsx(se,{visible:re,overlayProps:{blur:2}}),v&&e.jsxs(N,{color:"red",ta:"center",children:["Error al cargar pagos: ",v.message]}),e.jsxs(g,{justify:"space-between",mb:"xl",children:[e.jsx(z,{order:1,children:f&&(r!=null&&r.person_id)?"Mis Pagos":"Gestión de Pagos"}),e.jsxs(g,{children:[t&&e.jsx(x,{leftSection:e.jsx(fe,{size:16}),variant:"outline",onClick:A.open,children:"Filtros"}),t&&e.jsx(x,{leftSection:e.jsx(ye,{size:16}),onClick:X,"data-testid":"add-payment-button",children:"Añadir Pago"})]})]}),e.jsxs(ie,{shadow:"sm",p:"lg",radius:"md",withBorder:!0,mb:"xl",children:[e.jsxs(g,{mb:"lg",children:[e.jsx(oe,{size:"xl",color:f?"green":"blue",radius:"md",children:f?e.jsx(Pe,{size:24}):e.jsx(be,{size:24})}),e.jsx(z,{order:2,children:f&&(r!=null&&r.person_id)?"Historial de Pagos":"Pagos de Alquiler"})]}),w.length===0&&!D?e.jsxs(N,{c:"dimmed",ta:"center",py:"xl",children:["No se encontraron pagos.",(t||i)&&" Use el botón Añadir Pago para crear uno.",f&&" No tiene pagos registrados actualmente."]}):e.jsxs(s,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(s.Thead,{children:e.jsxs(s.Tr,{children:[t||i?e.jsx(s.Th,{children:"ID Pago"}):null,e.jsx(s.Th,{children:"Propiedad"}),(t||i)&&e.jsx(s.Th,{children:"Inquilino"}),e.jsx(s.Th,{children:"Fecha de Pago"}),e.jsx(s.Th,{children:"Cantidad"}),e.jsx(s.Th,{children:"Estado"}),(t||i)&&e.jsx(s.Th,{children:"Acciones"})]})}),e.jsx(s.Tbody,{children:w.map(a=>{const l=ee(a);return e.jsxs(s.Tr,{children:[t||i?e.jsxs(s.Td,{children:[a.id.substring(0,8),"..."]}):null,e.jsx(s.Td,{children:l.propertyAddress}),(t||i)&&e.jsx(s.Td,{children:l.renterName}),e.jsx(s.Td,{children:k(a.payment_date)}),e.jsxs(s.Td,{children:["$",a.amount_paid.toFixed(2)]}),e.jsx(s.Td,{children:e.jsx(le,{color:a.paid_on_time?"green":"red",children:a.paid_on_time?"A Tiempo":"Atrasado"})}),(t||i)&&_(a)&&e.jsx(s.Td,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(L,{variant:"subtle",color:"blue",onClick:()=>W(a),title:"Editar",children:e.jsx(je,{size:16})}),e.jsx(L,{variant:"subtle",color:"red",onClick:()=>Y(a),title:"Eliminar",children:e.jsx(_e,{size:16})})]})})]},a.id)})})]})]}),F&&(t||i)&&o&&e.jsxs(O,{opened:F,onClose:()=>j(!1),title:o.id?"Editar Pago":"Añadir Pago",centered:!0,children:[e.jsx(de,{label:"Alquiler Asociado",placeholder:"Seleccione un alquiler",required:!0,data:b.map(a=>({value:a.id,label:ae(a)})),value:o.rental_id||"",onChange:a=>h({...o,rental_id:a||""}),mb:"md",searchable:!0,nothingFoundMessage:"No hay alquileres disponibles"}),e.jsx(I,{label:"Fecha de Pago",value:o.payment_date?new Date(o.payment_date):new Date,onChange:a=>h({...o,payment_date:a==null?void 0:a.toISOString()}),required:!0,mb:"md"}),e.jsx(ce,{label:"Cantidad Pagada",placeholder:"Ingrese cantidad",required:!0,min:0,decimalScale:2,fixedDecimalScale:!0,value:o.amount_paid||0,onChange:a=>h({...o,amount_paid:Number(a)||0}),mb:"md"}),e.jsx(M,{label:"Pagado a Tiempo",checked:o.paid_on_time||!1,onChange:a=>h({...o,paid_on_time:a.currentTarget.checked}),mb:"xl"}),e.jsxs(g,{justify:"flex-end",children:[e.jsx(x,{variant:"default",onClick:()=>j(!1),children:"Cancelar"}),e.jsx(x,{onClick:Z,children:"Guardar Pago"})]})]}),t&&e.jsxs(O,{opened:K,onClose:A.close,title:"Filtrar Pagos",children:[e.jsx(I,{label:"Desde Fecha",value:B,onChange:H,mb:"sm",clearable:!0}),e.jsx(I,{label:"Hasta Fecha",value:Q,onChange:U,mb:"sm",clearable:!0}),e.jsx(M,{label:"Mostrar solo pagos atrasados",checked:J,onChange:a=>V(a.currentTarget.checked),mb:"xl"}),e.jsxs(g,{justify:"flex-end",children:[e.jsx(x,{variant:"default",onClick:A.close,children:"Cancelar"}),e.jsx(x,{disabled:!0,children:"Aplicar (No Implementado)"})]})]})]})}export{Fe as default};
