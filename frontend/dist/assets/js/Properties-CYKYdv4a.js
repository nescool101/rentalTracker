import{j as e,C as ee,L as re,b as l,G as g,a as R,B as z,P as K,T as A,k as j,q as n,r as ae,e as Q,o as se,l as T,s as ie,n as p}from"./mantine-vendor-Bripv_3X.js";import{r as x}from"./react-vendor-Cmr1RT9l.js";import{c as ne,u as I,a as te}from"./utils-vendor-tZ1hTSV2.js";import{a as C,p as de,u as oe}from"./apiService-19GZqUtM.js";import{c as le,u as ce,f as G}from"./index-BGAR1JXy.js";import{S as me}from"./StableModal-BsXR2I9w.js";import{I as pe,a as ue}from"./IconPlus-dymNjJLj.js";import{I as he}from"./IconSearch-f2W8sUQc.js";import{I as ge}from"./IconTrash-C4TwLzKL.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var xe=le("outline","home-check","IconHomeCheck",[["path",{d:"M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2",key:"svg-0"}],["path",{d:"M19 13.488v-1.488h2l-9 -9l-9 9h2v7a2 2 0 0 0 2 2h4.525",key:"svg-1"}],["path",{d:"M15 19l2 2l4 -4",key:"svg-2"}]]);function Te(){const[v,H]=x.useState(""),[s,d]=x.useState(null),[y,f]=x.useState(!1),[u,w]=x.useState(!1),[M,U]=x.useState([]),[k,N]=x.useState(!1),B=ne(),{user:a}=ce(),t=(a==null?void 0:a.role)==="admin",o=(a==null?void 0:a.role)==="manager",$=!t&&!o;x.useEffect(()=>{y||(w(!1),d(null))},[y]),x.useEffect(()=>{(async()=>{N(!0);try{const m=(await te.get("https://api-colombia.com/api/v1/Department")).data.map(h=>({value:h.id.toString(),label:h.name}));U(m)}catch(i){console.error("Error fetching departments:",i),p.show({title:"Error",message:"No se pudieron cargar los departamentos. Por favor, intenta nuevamente.",color:"red"})}finally{N(!1)}})()},[]);const{data:S=[],isLoading:E,error:b}=I({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id],queryFn:async()=>{if(!a)return[];try{return t||o?await C.getAll():a.person_id?await C.getByResidentId(a.person_id)||[]:[]}catch(r){return console.error("Error fetching properties:",r),p.show({title:"Error de Carga",message:"No se pudieron cargar las propiedades.",color:"red"}),[]}},enabled:!!a}),{data:P=[]}=I({queryKey:["persons","all","forPropertiesPageDropdowns"],queryFn:de.getAll,enabled:t||o}),{data:V=[]}=I({queryKey:["users","all","forPropertiesPageManagerDropdown"],queryFn:oe.getAll,enabled:t}),L=P.filter(r=>V.some(i=>i.person_id===r.id&&(i.role==="manager"||i.role==="admin"))),c=S.filter(r=>{var i,m,h;return r&&(((i=r.address)==null?void 0:i.toLowerCase().includes(v.toLowerCase()))||((m=r.city)==null?void 0:m.toLowerCase().includes(v.toLowerCase()))||((h=r.department)==null?void 0:h.toLowerCase().includes(v.toLowerCase())))}),J=r=>{d({...r}),w(!1),f(!0)},W=()=>{d({id:"",address:"",apt_number:"",city:"",state:"",department:"",department_id:"",zip_code:"",type:"",resident_id:o&&!t&&(a!=null&&a.person_id)?a.person_id:"",manager_ids:o&&!t&&(a!=null&&a.person_id)?[a.person_id]:[]}),w(!1),f(!0)},X=async r=>{if(!t){p.show({title:"Acceso Denegado",message:"No tiene permisos para eliminar propiedades.",color:"red"});return}if(window.confirm("¿Está seguro que desea eliminar esta propiedad?"))try{await C.delete(r),B.invalidateQueries({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id]}),p.show({title:"Éxito",message:"Propiedad eliminada correctamente",color:"green"})}catch{p.show({title:"Error",message:"Error al eliminar la propiedad",color:"red"})}},F=r=>{var O;if(!r)return"No asignado";const i=P||[],m=L||[],h=i.find(D=>D.id===r);return h?h.full_name:((O=m.find(D=>D.id===r))==null?void 0:O.full_name)||"ID no encontrado"},q=r=>!r||r.length===0?"No asignado":r.map(i=>F(i)).join(", "),Y=async()=>{if(w(!0),!s)return;if(!s.address||!s.city||!s.department_id||!s.zip_code||!s.type||t&&(!s.resident_id||!s.manager_ids||s.manager_ids.length===0)||o&&!t&&!s.resident_id){p.show({title:"Error de Validación",message:"Por favor complete todos los campos requeridos.",color:"red"});return}const r={...s};if(o&&!t&&(a!=null&&a.person_id)){const i=r.manager_ids?[...r.manager_ids]:[];i.includes(a.person_id)||i.push(a.person_id),r.manager_ids=i,(!r.resident_id||r.resident_id==="")&&(r.resident_id=a.person_id)}try{if(r.id)await C.update(r.id,r),p.show({title:"Éxito",message:"Propiedad actualizada correctamente",color:"green"});else{const{id:i,...m}=r;await C.create(m),p.show({title:"Éxito",message:"Propiedad creada correctamente",color:"green"})}B.invalidateQueries({queryKey:["properties",a==null?void 0:a.role,a==null?void 0:a.person_id]}),f(!1)}catch(i){console.error("Error saving property:",i),p.show({title:"Error",message:"Error al guardar la propiedad",color:"red"})}},_=t||o,Z=s!=null&&s.id?_?"Editar Propiedad":"Detalles de la Propiedad":"Añadir Propiedad";return e.jsxs(ee,{size:"xl",children:[e.jsx(re,{visible:E&&!b}),b&&e.jsxs(l,{color:"red",ta:"center",py:"xl",children:["Error al cargar propiedades: ",b.message]}),e.jsxs(g,{justify:"space-between",mb:"md",children:[e.jsx(R,{order:1,children:"Propiedades"}),t&&e.jsx(z,{leftSection:e.jsx(pe,{size:16}),onClick:W,"data-testid":"add-property-button",children:"Añadir Propiedad"})]}),o&&!t&&e.jsxs(K,{withBorder:!0,p:"md",mb:"lg",radius:"md",children:[e.jsxs(g,{align:"center",mb:"xs",children:[e.jsx(A,{color:"blue",size:"md",children:e.jsx(G,{size:16})}),e.jsx(l,{fw:500,children:"Información para Encargados"})]}),e.jsx(l,{size:"sm",mb:"md",children:"Como encargado, usted puede registrar una propiedad durante el proceso de registro. El administrador puede asignarle múltiples propiedades para gestionar o cambiar su estado de pago para activar su propiedad."}),S.filter(r=>{var i;return(i=r.manager_ids)==null?void 0:i.includes((a==null?void 0:a.person_id)||"")}).length===0&&e.jsx(l,{size:"sm",fs:"italic",c:"dimmed",children:"Para registrar su propiedad, complete el proceso de registro inicial del sistema. Si ya lo ha completado, contacte al administrador."})]}),(t||o)&&S.length>1&&e.jsx(j,{placeholder:"Buscar propiedades por dirección, ciudad o departamento...",mb:"md",leftSection:e.jsx(he,{size:16}),value:v,onChange:r=>H(r.currentTarget.value)}),(t||o)&&!E&&!b&&e.jsxs(n,{striped:!0,highlightOnHover:!0,withTableBorder:!0,mt:"lg",children:[e.jsx(n.Thead,{children:e.jsxs(n.Tr,{children:[e.jsx(n.Th,{children:"Dirección"}),e.jsx(n.Th,{children:"Ciudad"}),e.jsx(n.Th,{children:"Departamento"}),e.jsx(n.Th,{children:"Tipo"}),e.jsx(n.Th,{children:"Residente"}),e.jsx(n.Th,{children:"Encargado (Manager)"}),_&&e.jsx(n.Th,{children:"Acciones"})]})}),e.jsx(n.Tbody,{children:c.length===0?e.jsx(n.Tr,{children:e.jsx(n.Td,{colSpan:_?7:6,ta:"center",children:"No se encontraron propiedades."})}):c.map(r=>e.jsxs(n.Tr,{children:[e.jsxs(n.Td,{children:[r.address,r.apt_number?`, ${r.apt_number}`:""]}),e.jsx(n.Td,{children:r.city}),e.jsx(n.Td,{children:r.department||"No especificado"}),e.jsx(n.Td,{children:e.jsx(ae,{children:r.type})}),e.jsx(n.Td,{children:F(r.resident_id)}),e.jsx(n.Td,{children:q(r.manager_ids)}),_&&e.jsx(n.Td,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(Q,{variant:"subtle",color:"blue",onClick:()=>J(r),title:"Editar",children:e.jsx(ue,{size:16})}),t&&e.jsx(Q,{variant:"subtle",color:"red",onClick:()=>X(r.id),title:"Eliminar",children:e.jsx(ge,{size:16})})]})})]},r.id))})]}),$&&!E&&!b&&e.jsx(e.Fragment,{children:c.length===1?e.jsxs(se,{withBorder:!0,radius:"md",p:"xl",shadow:"sm",mt:"lg",children:[e.jsxs(g,{mb:"xs",children:[e.jsx(A,{variant:"light",size:36,radius:"md",children:e.jsx(xe,{size:20})}),e.jsx(R,{order:3,children:"Mi Propiedad"})]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Dirección:"})," ",c[0].address,c[0].apt_number?`, ${c[0].apt_number}`:""]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Ciudad:"})," ",c[0].city]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Departamento:"})," ",c[0].department||"No especificado"]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Código Postal:"})," ",c[0].zip_code]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Tipo:"})," ",c[0].type]}),e.jsxs(l,{children:[e.jsx("strong",{children:"Encargado:"})," ",q(c[0].manager_ids)]})]}):e.jsxs(K,{withBorder:!0,p:"xl",radius:"md",shadow:"sm",mt:"lg",children:[e.jsx(g,{justify:"center",mb:"sm",children:e.jsx(A,{variant:"light",color:"gray",size:48,radius:"xl",children:e.jsx(G,{size:28})})}),e.jsx(l,{ta:"center",c:"dimmed",children:"No tiene una propiedad asignada actualmente o no se pudo cargar la información."}),e.jsx(l,{ta:"center",c:"dimmed",fz:"xs",children:"Si cree que esto es un error, por favor contacte con la administración."})]})}),s&&y&&_&&e.jsxs(me,{opened:y,onClose:()=>f(!1),title:Z,centered:!0,size:"lg",children:[e.jsx(j,{label:"Dirección",placeholder:"Ingrese dirección",required:!0,mb:"sm",value:s.address,onChange:r=>d({...s,address:r.target.value}),error:u&&!s.address?"Campo requerido":null}),e.jsx(j,{label:"Nº Apartamento (Opcional)",placeholder:"Ej: Apto 101",mb:"sm",value:s.apt_number||"",onChange:r=>d({...s,apt_number:r.target.value})}),e.jsxs(g,{grow:!0,mb:"sm",children:[e.jsx(T,{label:"Departamento",placeholder:k?"Cargando departamentos...":"Seleccione el departamento",data:M,disabled:k,searchable:!0,required:!0,value:s.department_id||"",onChange:r=>{const i=M.find(m=>m.value===r);d({...s,department_id:r||"",department:i?i.label:""})},error:u&&!s.department_id?"Campo requerido":null}),e.jsx(j,{label:"Ciudad",placeholder:"Ingrese ciudad",required:!0,value:s.city,onChange:r=>d({...s,city:r.target.value}),error:u&&!s.city?"Campo requerido":null})]}),e.jsxs(g,{grow:!0,mb:"sm",children:[e.jsx(j,{label:"Código Postal",placeholder:"Ingrese código postal",required:!0,value:s.zip_code,onChange:r=>d({...s,zip_code:r.target.value}),error:u&&!s.zip_code?"Campo requerido":null}),e.jsx(T,{label:"Tipo de Propiedad",placeholder:"Seleccione tipo",required:!0,data:["Apartamento","Casa","Condominio","Comercial","Otro"],value:s.type,onChange:r=>d({...s,type:r||""}),error:u&&!s.type?"Campo requerido":null})]}),t&&e.jsxs(e.Fragment,{children:[e.jsx(T,{label:"Residente Asignado",placeholder:"Seleccione residente",clearable:!0,mb:"sm",searchable:!0,data:P.map(r=>({value:r.id,label:r.full_name})),value:s.resident_id||"",onChange:r=>d({...s,resident_id:r||""}),error:u&&!s.resident_id?"Debe asignar un residente":null}),e.jsx(ie,{label:"Encargado(s) (Manager)",placeholder:"Seleccione encargado(s)",clearable:!0,searchable:!0,mb:"lg",data:L.map(r=>({value:r.id,label:r.full_name})),value:s.manager_ids||[],onChange:r=>d({...s,manager_ids:r||[]}),error:u&&t&&(!s.manager_ids||s.manager_ids.length===0)?"Debe asignar al menos un encargado":null})]}),o&&!t&&e.jsxs(e.Fragment,{children:[e.jsx(T,{label:"Residente Asignado",placeholder:"Seleccione residente",clearable:!0,mb:"sm",searchable:!0,data:P.map(r=>({value:r.id,label:r.full_name})),value:s.resident_id||"",onChange:r=>d({...s,resident_id:r||""}),error:u&&!s.resident_id?"Debe asignar un residente":null,description:"De forma temporal, usted puede ser asignado como residente hasta que se cree el inquilino. Si no selecciona a nadie, se usará su información automáticamente."}),e.jsx(j,{label:"Encargado(s) (Manager)",disabled:!0,value:q(s.manager_ids),mb:"lg",description:s.id?"Para cambiar encargados, contacte a un administrador.":"Usted será asignado como encargado."})]}),e.jsxs(g,{justify:"flex-end",children:[e.jsx(z,{variant:"default",onClick:()=>f(!1),children:"Cancelar"}),e.jsx(z,{onClick:Y,children:"Guardar Propiedad"})]})]})]})}export{Te as default};
