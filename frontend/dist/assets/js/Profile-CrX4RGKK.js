import{j as e,C as k,a as l,b as y,v as G,P as E,L as S,S as z,k as c,G as _,B as A,w as d,D as F,n as D}from"./mantine-vendor-D4AgWXPI.js";import{r as o}from"./react-vendor-Q26-omST.js";import{u as U,d as M,e as I}from"./index-cX4OG7Q0.js";import{p as N,u as O}from"./apiService-758Vinm-.js";import{a as R}from"./utils-vendor-CNi8B-Rx.js";function V(){const{user:r,logout:L}=U(),[u,t]=o.useState(!1),[m,s]=o.useState(""),[f,p]=o.useState(""),[h,x]=o.useState(""),[j,g]=o.useState(""),[v,b]=o.useState(""),[i,w]=o.useState(""),[P,C]=o.useState("");o.useEffect(()=>{r!=null&&r.person_id&&T()},[r]);const T=async()=>{t(!0);try{if(!(r!=null&&r.person_id))return;const a=await N.getById(r.person_id);a&&(p(a.full_name||""),x(a.phone||""),g(a.address||""))}catch(a){console.error("Error fetching person data:",a),s("No se pudo cargar su información personal.")}finally{t(!1)}},B=async a=>{a.preventDefault(),t(!0),s("");try{if(!(r!=null&&r.person_id)){s("No se encontró información de perfil asociada a su cuenta.");return}await N.update(r.person_id,{id:r.person_id,full_name:f,phone:h,address:j}),D.show({title:"Perfil actualizado",message:"Su información personal ha sido actualizada exitosamente.",color:"green",icon:e.jsx(I,{size:16})})}catch(n){console.error("Error updating profile:",n),s("Error al actualizar su información personal.")}finally{t(!1)}},q=async a=>{if(a.preventDefault(),!v){s("Debe ingresar su contraseña actual");return}if(!i||i.length<8){s("La nueva contraseña debe tener al menos 8 caracteres");return}if(i!==P){s("Las contraseñas nuevas no coinciden");return}t(!0),s("");try{if(!(r!=null&&r.id)||!r.email){s("Información de usuario incompleta");return}await O.update(r.id,{email:r.email,role:r.role,person_id:r.person_id,password_base64:btoa(i)}),D.show({title:"Contraseña actualizada",message:"Su contraseña ha sido actualizada exitosamente. Por favor, inicie sesión nuevamente.",color:"green",icon:e.jsx(I,{size:16})}),b(""),w(""),C(""),await L(),setTimeout(()=>{window.location.href="/login"},2e3)}catch(n){console.error("Error updating password:",n),R.isAxiosError(n)&&n.response?s(`Error al actualizar su contraseña: ${n.response.data.error||"Error desconocido"}`):s("Error al actualizar su contraseña. Por favor, inténtelo de nuevo.")}finally{t(!1)}};return e.jsxs(k,{size:"md",children:[e.jsx(l,{order:2,mb:"md",children:"Mi Perfil"}),e.jsx(y,{c:"dimmed",mb:"xl",children:"Actualice su información personal y contraseña"}),m&&e.jsx(G,{icon:e.jsx(M,{size:16}),title:"Error",color:"red",mb:"md",children:m}),e.jsxs(E,{withBorder:!0,p:"xl",radius:"md",mb:"xl",pos:"relative",children:[e.jsx(S,{visible:u}),e.jsx(l,{order:3,mb:"lg",children:"Información Personal"}),e.jsx("form",{onSubmit:B,children:e.jsxs(z,{children:[e.jsx(c,{label:"Nombre completo",placeholder:"Nombre completo",value:f,onChange:a=>p(a.target.value),required:!0}),e.jsx(c,{label:"Teléfono",placeholder:"Teléfono de contacto",value:h,onChange:a=>x(a.target.value)}),e.jsx(c,{label:"Dirección",placeholder:"Dirección",value:j,onChange:a=>g(a.target.value)}),e.jsx(_,{justify:"flex-end",mt:"md",children:e.jsx(A,{type:"submit",children:"Guardar cambios"})})]})})]}),e.jsxs(E,{withBorder:!0,p:"xl",radius:"md",pos:"relative",children:[e.jsx(S,{visible:u}),e.jsx(l,{order:3,mb:"lg",children:"Cambiar Contraseña"}),e.jsx("form",{onSubmit:q,children:e.jsxs(z,{children:[e.jsx(d,{label:"Contraseña actual",placeholder:"Ingrese su contraseña actual",value:v,onChange:a=>b(a.target.value),required:!0}),e.jsx(F,{my:"md"}),e.jsx(d,{label:"Nueva contraseña",placeholder:"Ingrese su nueva contraseña",value:i,onChange:a=>w(a.target.value),required:!0}),e.jsx(d,{label:"Confirmar nueva contraseña",placeholder:"Confirme su nueva contraseña",value:P,onChange:a=>C(a.target.value),required:!0}),e.jsx(y,{size:"xs",c:"dimmed",children:"La contraseña debe tener al menos 8 caracteres."}),e.jsx(_,{justify:"flex-end",mt:"md",children:e.jsx(A,{type:"submit",color:"blue",children:"Actualizar contraseña"})})]})})]})]})}export{V as default};
