import{K as U,j as e,g as H,a as I,P as N,S as w,F as o,l as c,w as A,Q,x as F,y as J,v as P,G as E,B as m,E as W,b as k,n as u}from"./mantine-vendor-Bripv_3X.js";import{r as x}from"./react-vendor-Cmr1RT9l.js";import{u as M,a as S}from"./utils-vendor-tZ1hTSV2.js";import{f as X,p as Y,a as Z}from"./apiService-19GZqUtM.js";import{m as ee,g as D,I as C,a as ae}from"./index-BGAR1JXy.js";import{I as re}from"./IconSignature-D67Ojd7u.js";const R=S.create({baseURL:"/api",headers:{"Content-Type":"application/json"}});R.interceptors.request.use(i=>{const s=ae.getToken();return console.log("Auth token from authService:",s),s&&(i.headers.Authorization=`Bearer ${s}`),i},i=>Promise.reject(i));const de=()=>{const[i,s]=x.useState(!1),[g,v]=x.useState(null),[$,p]=x.useState(!1),[T,q]=x.useState(!1),{data:b,isLoading:h}=M({queryKey:["personsForContract"],queryFn:Y.getAll}),{data:j,isLoading:G}=M({queryKey:["propertiesForContract"],queryFn:Z.getAll}),r=U({initialValues:{renter_id:"",owner_id:"",property_id:"",cosigner_id:"",witness_id:"",start_date:null,end_date:null,contract_duration:"6",monthly_rent:0,requires_deposit:!1,deposit_amount:0,deposit_text:"El depósito será utilizado para cubrir cualquier renta no pagada o daños a la propiedad.",additional_info:""},validate:{renter_id:a=>a?null:"Arrendatario es requerido",owner_id:a=>a?null:"Arrendador es requerido",property_id:a=>a?null:"Propiedad es requerida",start_date:a=>a?null:"Fecha de inicio es requerida",monthly_rent:a=>a<=0?"El precio de renta mensual es requerido":null,deposit_amount:(a,t)=>t.requires_deposit&&a<=0?"El monto del depósito es requerido":null}}),f=b||[],_=b||[],l=b||[],y=(a,t)=>{if(!a)return null;const n=new Date(a);return n.setMonth(n.getMonth()+t),n},L=a=>{r.setFieldValue("contract_duration",a);const t=parseInt(a,10),n=y(r.values.start_date,t);r.setFieldValue("end_date",n)},z=a=>{if(r.setFieldValue("start_date",a),a){const t=parseInt(r.values.contract_duration,10),n=y(a,t);r.setFieldValue("end_date",n)}},B=async a=>{s(!0);try{const t=await R.post("/contracts/generate",a,{responseType:"blob"}),n=t.headers["x-contract-id"];n&&v(n);const V=new Blob([t.data],{type:"application/pdf"}),K=window.URL.createObjectURL(V),d=document.createElement("a");d.href=K,d.setAttribute("download","contrato_arrendamiento.pdf"),document.body.appendChild(d),d.click(),document.body.removeChild(d),u.show({title:"Contrato generado",message:"El contrato ha sido generado exitosamente",color:"green",icon:e.jsx(D,{})})}catch(t){console.error("Error generating contract:",t);let n="Ha ocurrido un error al generar el contrato.";S.isAxiosError(t)&&t.response&&(n=t.response.data.error||n),u.show({title:"Error",message:n,color:"red",icon:e.jsx(C,{})})}finally{s(!1)}},O=async()=>{if(!g||!r.values.renter_id){u.show({title:"Error",message:"No se puede solicitar firma sin generar un contrato primero",color:"red",icon:e.jsx(C,{})});return}q(!0);try{await X.requestSignature({contract_id:g,recipient_id:r.values.renter_id,expiration_days:7}),u.show({title:"Solicitud de firma enviada",message:"El correo electrónico con la solicitud de firma ha sido enviado correctamente",color:"green",icon:e.jsx(D,{})}),r.reset(),v(null),p(!1)}catch(a){console.error("Error requesting signature:",a);let t="Ha ocurrido un error al solicitar la firma.";S.isAxiosError(a)&&a.response&&(t=a.response.data.error||t),u.show({title:"Error",message:t,color:"red",icon:e.jsx(C,{})})}finally{q(!1)}};return e.jsxs(H,{children:[e.jsx(I,{order:2,mb:"md",children:"Generación de Contratos de Arrendamiento"}),e.jsx(N,{shadow:"xs",p:"md",withBorder:!0,children:e.jsx("form",{onSubmit:r.onSubmit(B),children:e.jsxs(w,{children:[e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(c,{label:"Arrendatario",description:"Persona que alquilará la propiedad",data:(f==null?void 0:f.map(a=>({value:a.id,label:`${a.full_name} (${a.nit})`})))||[],placeholder:"Seleccione el arrendatario",searchable:!0,withAsterisk:!0,disabled:h,...r.getInputProps("renter_id")})}),e.jsx(o.Col,{span:6,children:e.jsx(c,{label:"Arrendador",description:"Propietario de la propiedad",data:(_==null?void 0:_.map(a=>({value:a.id,label:`${a.full_name} (${a.nit})`})))||[],placeholder:"Seleccione el arrendador",searchable:!0,withAsterisk:!0,disabled:h,...r.getInputProps("owner_id")})})]}),e.jsx(o,{children:e.jsx(o.Col,{span:12,children:e.jsx(c,{label:"Propiedad",description:"Propiedad que será arrendada",data:(j==null?void 0:j.map(a=>({value:a.id,label:`${a.address} (${a.type})`})))||[],placeholder:"Seleccione la propiedad",searchable:!0,withAsterisk:!0,disabled:G,...r.getInputProps("property_id")})})}),e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(c,{label:"Deudor Solidario (Opcional)",description:"Persona que responderá como garantía adicional",data:(l==null?void 0:l.map(a=>({value:a.id,label:`${a.full_name} (${a.nit})`})))||[],placeholder:"Seleccione el deudor solidario (opcional)",searchable:!0,disabled:h,clearable:!0,...r.getInputProps("cosigner_id")})}),e.jsx(o.Col,{span:6,children:e.jsx(c,{label:"Testigo (Opcional)",description:"Persona que será testigo del contrato",data:(l==null?void 0:l.map(a=>({value:a.id,label:`${a.full_name} (${a.nit})`})))||[],placeholder:"Seleccione el testigo (opcional)",searchable:!0,disabled:h,clearable:!0,...r.getInputProps("witness_id")})})]}),e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(A,{label:"Fecha de Inicio",description:"Fecha en que inicia el contrato",placeholder:"Seleccione la fecha de inicio",withAsterisk:!0,value:r.values.start_date,onChange:z,error:r.errors.start_date})}),e.jsx(o.Col,{span:6,children:e.jsxs(w,{gap:"xs",children:[e.jsx(I,{order:6,children:"Duración del Contrato"}),e.jsx(Q,{data:[{label:"6 Meses",value:"6"},{label:"12 Meses",value:"12"},{label:"24 Meses",value:"24"}],value:r.values.contract_duration,onChange:L}),e.jsx(A,{label:"Fecha de Finalización",description:"Calculada automáticamente según duración",placeholder:"Fecha de finalización",value:r.values.end_date,disabled:!0})]})})]}),e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(F,{label:"Renta Mensual",description:"Monto a pagar mensualmente",placeholder:"Ingrese el monto de la renta",withAsterisk:!0,min:0,...r.getInputProps("monthly_rent")})}),e.jsx(o.Col,{span:6,children:e.jsx(J,{label:"Requiere Depósito",description:"Marque si se requiere un depósito de garantía",checked:r.values.requires_deposit,onChange:a=>r.setFieldValue("requires_deposit",a.currentTarget.checked),mt:"md"})})]}),r.values.requires_deposit&&e.jsxs(o,{children:[e.jsx(o.Col,{span:6,children:e.jsx(F,{label:"Monto de Depósito",description:"Monto del depósito de garantía",placeholder:"Ingrese el monto del depósito",withAsterisk:!0,min:0,...r.getInputProps("deposit_amount")})}),e.jsx(o.Col,{span:6,children:e.jsx(P,{label:"Texto del Depósito",description:"Descripción de las condiciones del depósito",placeholder:"Ingrese el texto sobre las condiciones del depósito",...r.getInputProps("deposit_text")})})]}),e.jsx(P,{label:"Información Adicional (Opcional)",description:"Cláusulas adicionales u observaciones para el contrato",placeholder:"Ingrese información adicional para el contrato",minRows:4,maxRows:8,...r.getInputProps("additional_info")}),e.jsx(o,{mt:"md",children:e.jsx(o.Col,{children:e.jsxs(E,{children:[e.jsx(m,{leftSection:e.jsx(ee,{}),type:"submit",loading:i,disabled:i,children:"Generar Contrato PDF"}),g&&e.jsx(m,{leftSection:e.jsx(re,{}),color:"blue",onClick:()=>p(!0),disabled:i,children:"Solicitar Firma"})]})})})]})})}),e.jsxs(W,{opened:$,onClose:()=>p(!1),title:"Solicitar Firma de Contrato",children:[e.jsx(k,{size:"sm",mb:"md",children:"Está a punto de enviar una solicitud de firma electrónica al arrendatario. Se le enviará un correo electrónico con un enlace para revisar y firmar el contrato."}),e.jsx(k,{size:"sm",mb:"md",children:"El enlace de firma estará activo por 7 días."}),e.jsxs(E,{justify:"space-between",mt:"xl",children:[e.jsx(m,{variant:"outline",onClick:()=>p(!1),children:"Cancelar"}),e.jsx(m,{loading:T,onClick:O,children:"Confirmar y Enviar"})]})]})]})};export{de as default};
