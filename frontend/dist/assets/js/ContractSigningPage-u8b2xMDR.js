import{j as e,V as R,W as N,g as u,m as i,a as B,P as L,S as C,B as g,b as U,G as $,n}from"./mantine-vendor-Bripv_3X.js";import{j as G,r as o}from"./react-vendor-Cmr1RT9l.js";import{f as c}from"./apiService-19GZqUtM.js";import{I as l,g as E,n as f}from"./index-BGAR1JXy.js";import{I as T}from"./IconDownload-CF5TjiM4.js";import{I as P}from"./IconSignature-D67Ojd7u.js";import"./utils-vendor-tZ1hTSV2.js";const K=()=>{const{signingId:t}=G(),[v,h]=o.useState(!0),[d,m]=o.useState(null),[x,j]=o.useState(null),[a,p]=o.useState(null),[D,S]=o.useState(!1),[I,w]=o.useState(!1),[b,y]=o.useState(!1);o.useEffect(()=>{(async()=>{if(!t){j("ID de firma no proporcionado"),h(!1);return}try{const s=await c.getSignatureStatus(t);m(s),p(`/api/public/contract-signing/pdf/${t}`)}catch(s){console.error("Error fetching signature status:",s),j("No se pudo obtener la información de firma del contrato.")}finally{h(!1)}})()},[t]);const F=async()=>{if(t){S(!0);try{await c.signContract(t),n.show({title:"Contrato firmado",message:"El contrato ha sido firmado exitosamente.",color:"green",icon:e.jsx(E,{})});const r=await c.getSignatureStatus(t);m(r),p(`/api/public/contract-signing/pdf/${t}?signed=true`)}catch(r){console.error("Error signing contract:",r),n.show({title:"Error",message:"No se pudo firmar el contrato. Por favor intente nuevamente.",color:"red",icon:e.jsx(l,{})})}finally{S(!1)}}},z=async()=>{if(t){w(!0);try{await c.rejectContract(t),n.show({title:"Firma rechazada",message:"Ha rechazado la firma del contrato.",color:"yellow",icon:e.jsx(f,{})});const r=await c.getSignatureStatus(t);m(r)}catch(r){console.error("Error rejecting contract:",r),n.show({title:"Error",message:"No se pudo rechazar la firma. Por favor intente nuevamente.",color:"red",icon:e.jsx(l,{})})}finally{w(!1)}}},k=()=>{if(a){y(!0);try{const r=document.createElement("a");r.href=a,r.setAttribute("download","contrato.pdf"),document.body.appendChild(r),r.click(),document.body.removeChild(r),n.show({title:"Descarga iniciada",message:"La descarga del contrato ha comenzado.",color:"blue"})}catch(r){console.error("Error downloading PDF:",r),n.show({title:"Error",message:"No se pudo descargar el contrato. Por favor intente nuevamente.",color:"red",icon:e.jsx(l,{})})}finally{y(!1)}}},A=()=>{if(!d)return null;const r=d.status,s=d.status_spanish||"Pendiente";return r==="signed"?e.jsxs(C,{children:[e.jsxs(i,{title:"Contrato Firmado",color:"green",icon:e.jsx(E,{}),children:["Este contrato ya ha sido firmado el ",new Date(d.signed_at).toLocaleDateString(),"."]}),a&&e.jsxs(e.Fragment,{children:[e.jsx(u,{my:"md",children:e.jsx("iframe",{src:a,style:{width:"100%",height:"500px",border:"1px solid #eee"},title:"Contrato de Arrendamiento Firmado"})}),e.jsx(g,{leftSection:e.jsx(T,{}),onClick:k,loading:b,children:"Descargar Contrato Firmado"})]})]}):r==="rejected"?e.jsx(i,{title:"Firma Rechazada",color:"red",icon:e.jsx(f,{}),children:"Usted ha rechazado la firma de este contrato."}):r==="expired"?e.jsx(i,{title:"Solicitud Expirada",color:"yellow",icon:e.jsx(l,{}),children:"Esta solicitud de firma ha expirado. Por favor contacte al remitente para una nueva solicitud."}):e.jsxs(C,{children:[e.jsx(i,{title:`Estado: ${s}`,color:"blue",icon:e.jsx(P,{}),children:"Este contrato está pendiente de su firma. Por favor revise el documento antes de firmar."}),a?e.jsx(u,{my:"md",children:e.jsx("iframe",{src:a,style:{width:"100%",height:"500px",border:"1px solid #eee"},title:"Contrato de Arrendamiento"})}):e.jsx(U,{color:"dimmed",ta:"center",my:"xl",children:"No se pudo cargar la vista previa del contrato. Puede proceder a firmarlo o rechazarlo."}),e.jsxs($,{children:[e.jsx(g,{color:"red",leftSection:e.jsx(f,{}),onClick:z,loading:I,children:"Rechazar"}),e.jsx(g,{color:"green",leftSection:e.jsx(P,{}),onClick:F,loading:D,children:"Firmar Contrato"})]})]})};return v?e.jsx(R,{p:"2rem",children:e.jsx(N,{size:"lg"})}):x?e.jsx(u,{children:e.jsx(i,{title:"Error",color:"red",icon:e.jsx(l,{}),children:x})}):e.jsxs(u,{children:[e.jsx(B,{order:2,mb:"md",children:"Firma de Contrato de Arrendamiento"}),e.jsx(L,{shadow:"xs",p:"md",withBorder:!0,children:A()})]})};export{K as default};
